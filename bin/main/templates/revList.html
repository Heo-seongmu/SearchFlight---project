<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8" />
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<title
	th:text="${viewType == 'cancelled' ? '무성의 여행 - 취소 내역' : '무성의 여행 - 예약 내역'}">무성의
	여행 예약 내역</title>
	
<!-- 공통 헤드 (폰트, 기본 스타일 등) 가져오기 -->
<th:block th:replace="layout/header_fragment :: common-head"></th:block>

<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
/* [수정됨] 헤더 관련 스타일(.moana_gnb 등) 제거됨.
   이제 common-head에서 스타일을 가져오므로 충돌하지 않습니다.
*/

/* --- 예약 내역 페이지 전용 스타일 --- */

.main-container {
	max-width: 1200px;
	margin: 0 auto;
	padding: 40px 20px;
}

.page-title {
	font-size: 28px;
	font-weight: 800;
	margin-bottom: 30px;
	color: #333;
}

/* 카드 디자인 */
.booking-card {
	background-color: #fff;
	border-radius: 12px;
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
	margin-bottom: 24px;
	overflow: hidden;
	transition: box-shadow 0.2s ease-in-out;
}

.booking-card:hover {
	box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}

.card-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 16px 24px;
	background-color: #f8f9fa;
	border-bottom: 1px solid #e9ecef;
	font-size: 14px;
}

.header-left {
	display: flex;
	align-items: center;
	gap: 12px;
}

.booking-date {
	color: #666;
}

/* 뱃지 스타일 */
.trip-type-badge {
	padding: 3px 10px;
	border-radius: 10px;
	font-size: 13px;
	font-weight: bold;
	border: 1px solid;
}

.trip-type-badge.oneway {
	background-color: #f0f5ff;
	color: #2f54eb;
	border-color: #adc6ff;
}

.trip-type-badge.roundtrip {
	background-color: #f6ffed;
	color: #52c41a;
	border-color: #b7eb8f;
}

.status-badge {
	padding: 4px 10px;
	border-radius: 12px;
	font-weight: bold;
	font-size: 13px;
}

.status-confirmed {
	background-color: #e6f7ff;
	color: #1890ff;
}

.status-cancelled {
	background-color: #fff1f0;
	color: #ff4d4f;
}

.card-body {
	padding: 24px;
}

.segment-divider {
	border: 0;
	height: 1px;
	background-color: #e9ecef;
	margin: 20px 0;
}

.flight-segment {
	display: flex;
	align-items: center;
	justify-content: space-between;
	gap: 20px;
}

.segment-airline, .segment-schedule {
	display: flex;
	align-items: center;
	gap: 8px;
	color: #555;
	min-width: 220px;
}

.segment-airline i, .segment-schedule i {
	color: #5ac4c9;
	font-size: 1.2em;
}

.segment-airline i.return-flight {
	transform: scaleX(-1);
}

.segment-route {
	flex-grow: 1;
	text-align: center;
	font-size: 18px;
	font-weight: bold;
}

.segment-route small {
	font-size: 14px;
	color: #888;
	font-weight: normal;
	margin: 0 2px;
}

.segment-route .arrow {
	color: #5ac4c9;
	margin: 0 16px;
}

.flight-duration {
	font-size: 14px;
	color: #888;
	font-weight: normal;
	margin-left: 8px;
}

.card-footer {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 16px 24px;
	background-color: #f8f9fa;
	border-top: 1px solid #e9ecef;
}

.total-price {
	display: flex;
	flex-direction: column;
}

.total-price span {
	font-size: 13px;
	color: #666;
}

.total-price strong {
	font-size: 22px;
	font-weight: 800;
	color: #d91f29;
}

.btn-cancel {
	background-color: transparent;
	border: 1px solid #ff4d4f;
	color: #ff4d4f;
	padding: 8px 16px;
	border-radius: 6px;
	font-weight: bold;
	cursor: pointer;
	transition: all 0.2s ease;
}

.btn-cancel:hover {
	background-color: #ff4d4f;
	color: #fff;
}

.no-booking-message {
	text-align: center;
	padding: 80px 20px;
	background-color: #fff;
	border-radius: 12px;
}

.no-booking-message p {
	font-size: 18px;
	color: #555;
	margin-bottom: 24px;
}

.btn-home {
	background-color: #5ac4c9;
	color: #fff;
	padding: 12px 24px;
	text-decoration: none;
	font-weight: bold;
	border-radius: 8px;
	transition: background-color 0.2s ease;
}

.btn-home:hover {
	background-color: #4aa0a5;
}

/* 다시 예약 버튼 */
.btn-rebook {
	background-color: #5ac4c9;
	color: #fff;
	padding: 8px 16px;
	border: 1px solid #5ac4c9;
	border-radius: 6px;
	font-weight: bold;
	cursor: pointer;
	text-decoration: none;
	transition: all 0.2s ease;
}

.btn-rebook:hover {
	background-color: #4aa0a5;
	border-color: #4aa0a5;
}

/* 모달 스타일 */
.modal-overlay {
	display: none;
	position: fixed;
	z-index: 1000;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	overflow: auto;
	background-color: rgba(0, 0, 0, 0.5);
	align-items: center;
	justify-content: center;
}

.modal-content {
	background-color: #fefefe;
	margin: auto;
	padding: 24px;
	border: 1px solid #888;
	width: 90%;
	max-width: 400px;
	border-radius: 8px;
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
	text-align: center;
}

.modal-content h4 {
	margin-top: 0;
	font-size: 20px;
	color: #333;
}

.modal-content p {
	font-size: 16px;
	color: #555;
	margin-bottom: 24px;
}

.modal-actions {
	display: flex;
	justify-content: center;
	gap: 10px;
}

.modal-actions button, .modal-actions a {
	padding: 8px 16px;
	border-radius: 6px;
	font-weight: bold;
	cursor: pointer;
	text-decoration: none;
	font-size: 15px;
	border: 1px solid transparent;
}

.btn-modal-secondary {
	background-color: #f0f0f0;
	border-color: #ccc;
	color: #333;
}

.btn-modal-secondary:hover {
	background-color: #e0e0e0;
}

.btn-modal-danger {
	background-color: #ff4d4f;
	color: #fff;
	border-color: #ff4d4f;
}

.btn-modal-danger:hover {
	background-color: #d9363e;
}

.btn-modal-primary {
	background-color: #5ac4c9;
	color: #fff;
	border-color: #5ac4c9;
}

.btn-modal-primary:hover {
	background-color: #4aa0a5;
}

/* 스피너 스타일 */
.spinner {
	width: 50px;
	height: 50px;
	border: 5px solid #f0f0f0; 
	border-top: 5px solid #5ac4c9; 
	border-radius: 50%;
	animation: spin 1s linear infinite;
}

@keyframes spin {
	0% { transform: rotate(0deg); }
	100% { transform: rotate(360deg); }
}

.spinner-container {
	display: flex;
	flex-direction: column; 
	align-items: center;    
	gap: 16px;              
}

.spinner-text {
	font-size: 18px;
	font-weight: bold;
	color: #ffffff; 
	margin: 0; 
}
</style>
</head>
<body>
    <!-- 공통 헤더 적용 (예약 내역 페이지이므로 activeMenu는 비워둠) -->
	<header th:replace="layout/header_fragment :: common-header(activeMenu='')"></header>

	<main class="main-container">

		<div
			style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
			<h2 class="page-title" style="margin-bottom: 0;"
				th:text="${viewType == 'cancelled' ? '취소된 예약 내역' : '나의 예약 내역'}">
				나의 예약 내역</h2>

			<a th:if="${viewType == 'RESERVED'}" href="/revCancelList"
				style="text-decoration: none; color: #555; font-weight: 500;">
				취소된 내역 보기 &gt; </a> <a th:if="${viewType == 'cancelled'}"
				href="/revList"
				style="text-decoration: none; color: #555; font-weight: 500;">
				예약된 내역 보기 &gt; </a>
		</div>

		<div th:if="${#lists.isEmpty(bookingList)}" class="no-booking-message">
			<p th:if="${viewType == 'RESERVED'}">아직 예약 내역이 없습니다.</p>
			<p th:if="${viewType == 'cancelled'}">취소된 예약 내역이 없습니다.</p>
			<a href="/" class="btn-home">항공권 검색하러 가기</a>
		</div>

		<div th:unless="${#lists.isEmpty(bookingList)}"
			th:each="booking : ${bookingList}" class="booking-card">

			<div class="card-header">
				<div class="header-left">
					<span class="booking-date"
						th:text="'예약일: ' + ${#temporals.format(booking.createdAt, 'yyyy-MM-dd')}">예약일:
						2025-10-18</span> <span th:if="${booking.returnAirline == null}"
						class="trip-type-badge oneway">편도</span> <span
						th:if="${booking.returnAirline != null}"
						class="trip-type-badge roundtrip">왕복</span>
				</div>
				<span class="status-badge"
					th:text="${booking.bookingStatus == 'RESERVED' ? '예약 확정' : '예약 취소'}"
					th:classappend="${booking.bookingStatus == 'RESERVED' ? 'status-confirmed' : 'status-cancelled'}">
					예약 확정 </span>
			</div>

			<div class="card-body">
				<div class="flight-segment">
					<div class="segment-airline">
						<i class="bi bi-airplane-fill"></i> <span
							th:text="${booking.departureAirline} + ' 항공'">7C 항공</span>
					</div>
					<div class="segment-route">
						<strong><span th:text="${booking.departureOriginCode}">ICN</span></strong>
						<small th:text="'(' + ${booking.departureKoLocation} + ')'">(서울/인천)</small>
						<span class="arrow">→</span> <strong><span
							th:text="${booking.departureDestinationCode}">KIX</span></strong> <small
							th:text="'(' + ${booking.arrivalKoLocation} + ')'">(오사카)</small>
					</div>
					<div class="segment-schedule">
						<i class="bi bi-clock"></i> <span
							th:text="${#temporals.format(booking.departureTime, 'yyyy-MM-dd HH:mm')} + ' ~ ' + ${#temporals.format(booking.departureArrivalTime, 'HH:mm')}">2025-10-22
							17:00 ~ 18:50</span> <span class="flight-duration"
							th:with="depDuration = ${T(java.time.Duration).between(booking.departureTime, booking.departureArrivalTime)}"
							th:text="'(총 ' + ${depDuration.toHours()} + '시간 ' + (${depDuration.toMinutes() % 60}) + '분)'">
							(총 1시간 50분) </span>
					</div>
				</div>
				<th:block th:if="${booking.returnAirline != null}">
					<hr class="segment-divider" />
					<div class="flight-segment">
						<div class="segment-airline">
							<i class="bi bi-airplane-fill return-flight"></i> <span
								th:text="${booking.returnAirline} + ' 항공'">7C 항공</span>
						</div>
						<div class="segment-route">
							<strong><span th:text="${booking.returnOriginCode}">KIX</span></strong>
							<small th:text="'(' + ${booking.arrivalKoLocation} + ')'">(오사카)</small>
							<span class="arrow">→</span> <strong><span
								th:text="${booking.returnDestinationCode}">ICN</span></strong> <small
								th:text="'(' + ${booking.departureKoLocation} + ')'">(서울/인천)</small>
						</div>
						<div class="segment-schedule">
							<i class="bi bi-clock"></i> <span
								th:text="${#temporals.format(booking.returnTime, 'yyyy-MM-dd HH:mm')} + ' ~ ' + ${#temporals.format(booking.returnArrivalTime, 'HH:mm')}">2025-10-30
								11:50 ~ 13:50</span> <span class="flight-duration"
								th:with="retDuration = ${T(java.time.Duration).between(booking.returnTime, booking.returnArrivalTime)}"
								th:text="'(총 ' + ${retDuration.toHours()} + '시간 ' + (${retDuration.toMinutes() % 60}) + '분)'">
								(총 2시간 00분) </span>
						</div>
					</div>
				</th:block>
			</div>

			<div class="card-footer">

				<th:block th:if="${viewType == 'RESERVED'}">
					<div class="total-price">
						<span>총 결제 금액</span> <strong
							th:text="${#numbers.formatInteger(booking.totalPrice, 0, 'COMMA')} + '원'">183,579원</strong>
					</div>
					
					<div class="action-buttons" style="display: flex; gap: 8px;">
						<button class="btn-cancel"
							th:if="${booking.bookingStatus == 'RESERVED'}"
							th:onclick="openCancelModal([[${booking.id}]])">예약 취소</button>
						
						<button type="button" class="btn-rebook"
							th:onclick="showNearbyHotels([[${booking.departureDestinationCode}]])">근처 호텔</button>
					</div>
				</th:block>

				<th:block th:if="${viewType == 'cancelled'}">
					<div class="total-price">
						<span>(취소된 결제 금액)</span> <strong
							th:text="${#numbers.formatInteger(booking.totalPrice, 0, 'COMMA')} + '원'">...</strong>
					</div>
					<div class="action-buttons">
						<button class="btn-rebook"
							th:onclick="openRebookModal([[${booking.id}]])">다시 예약</button>
					</div>
				</th:block>

			</div>
		</div>
	</main>

	<div id="cancelConfirmModal" class="modal-overlay">
		<div class="modal-content">
			<h4>예약 취소 확인</h4>
			<p>정말 이 예약을 취소하시겠습니까?</p>
			<div class="modal-actions">
				<button class="btn-modal-secondary"
					onclick="closeModal('cancelConfirmModal')">아니요</button>
				<a id="confirmCancelButton" class="btn-modal-danger" href="#">예</a>
			</div>
		</div>
	</div>

	<div id="rebookConfirmModal" class="modal-overlay">
		<div class="modal-content">
			<h4>다시 예약 확인</h4>
			<p>취소된 예약을 '예약 확정' 상태로 되돌리시겠습니까?</p>
			<div class="modal-actions">
				<button class="btn-modal-secondary"
					onclick="closeModal('rebookConfirmModal')">아니요</button>
				<a id="confirmRebookButton" class="btn-modal-primary" href="#">예</a>
			</div>
		</div>
	</div>

	<div id="resultModal" class="modal-overlay"
		th:style="${cancelSuccess != null or cancelError != null or rebookSuccess != null} ? 'display:flex;' : 'display:none;'">
		<div class="modal-content">
			<h4>알림</h4>
			<p th:if="${cancelSuccess}" th:text="${cancelSuccess}"></p>
			<p th:if="${cancelError}" th:text="${cancelError}"></p>
			<p th:if="${rebookSuccess}" th:text="${rebookSuccess}"></p>
			<div class="modal-actions">
				<button class="btn-modal-primary"
					onclick="closeModal('resultModal')">확인</button>
			</div>
		</div>
	</div>
	
	<div id="spinnerModal" class="modal-overlay" style="display: none;">
		
		<div class="spinner-container">
			
			<div class="spinner"></div>
			
			<p class="spinner-text">근처 호텔 찾는 중...</p>
			
		</div>
	</div>

	<script type="text/javascript">
		// '예약 취소 확인' 모달 열기
		function openCancelModal(bookingId) {
			const confirmButton = document
					.getElementById('confirmCancelButton');
			confirmButton.href = '/air/bookings/cancel/' + bookingId;
			document.getElementById('cancelConfirmModal').style.display = 'flex';
		}

		// '다시 예약 확인' 모달 열기
		function openRebookModal(bookingId) {
			const confirmButton = document
					.getElementById('confirmRebookButton');
			// '다시 예약' 컨트롤러 URL로 설정
			confirmButton.href = '/air/bookings/rebook/' + bookingId;
			document.getElementById('rebookConfirmModal').style.display = 'flex';
		}

		// '모달 닫기' (공통)
		function closeModal(modalId) {
			document.getElementById(modalId).style.display = 'none';
		}
		
		function showSpinner() {
			document.getElementById('spinnerModal').style.display = 'flex';
		}

		// 스피너를 숨기는 함수
		function hideSpinner() {
			document.getElementById('spinnerModal').style.display = 'none';
		}

		/**
		 * '근처 호텔' 버튼 클릭 시 실행되는 비동기 함수
		 * @param {string} destinationCode - 도착지 IATA 코드 (예: 'KIX')
		 */
		async function showNearbyHotels(destinationCode) {
			
			// 1. 스피너 표시
			showSpinner();

			try {
				// 2. API 요청 (fetch 사용)
				const response = await fetch('/hotel/List?destination=' + destinationCode);

				// 3. 응답 확인
				if (!response.ok) {
					// 서버가 4xx, 5xx 등의 오류 코드를 반환한 경우
					throw new Error('서버 응답 오류 (상태: ' + response.status + ')');
				}

				// 4. 요청 성공
				console.log('API 요청 성공. 호텔 페이지로 이동합니다.');
				
				// 5. 페이지 이동
				window.location.href = '/hotel/List?destination=' + destinationCode;

			} catch (error) {
				// 6. 에러 처리
				console.error('호텔 정보 요청 중 오류 발생:', error);
				alert('페이지를 불러오는 데 실패했습니다. 잠시 후 다시 시도해 주세요.');
				
				// 7. 실패 시에는 스피너 숨김
				hideSpinner();
			}
		}
	</script>
</body>
</html>