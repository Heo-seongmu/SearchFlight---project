<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>ë¬´ì„±ì˜ ì±„íŒ… - ì—¬í–‰ ì¶”ì²œ</title>

<th:block th:replace="layout/header_fragment :: common-head"></th:block>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
	href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Open+Sans:wght@400;700&display=swap"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<link rel="stylesheet" href="css/animate.css">
<link rel="stylesheet" href="css/icomoon.css">
<link rel="stylesheet" href="css/bootstrap.css">
<link rel="stylesheet" href="css/style.css">

<script src="js/modernizr-2.6.2.min.js"></script>

<style type="text/css">
html {
	scroll-behavior: smooth;
}

body {
	font-family: 'Noto Sans KR', 'Open Sans', sans-serif;
	background-color: #f0f2f5;
	color: #333;
}

/* === [ë ˆì´ì•„ì›ƒ ìˆ˜ì •] ì „ì²´ ì»¨í…Œì´ë„ˆ === */
.chat-layout-wrapper {
	display: flex;
	max-width: 1600px;
	width: 95%;
	/* marginì„ ì¡°ì •í•˜ê³  ë†’ì´ë¥¼ í™”ë©´ í¬ê¸°ì˜ 85%ë¡œ ì„¤ì •í•˜ì—¬ ê½‰ ì°¨ê²Œ ë³´ì´ë„ë¡ ìˆ˜ì • */
	margin: 20px auto;
	gap: 20px;
	height: 85vh; /* ê¸°ì¡´ 800px -> 85vh (í™”ë©´ ë†’ì´ì˜ 85%) */
	min-height: 600px; /* ë„ˆë¬´ ì‘ì•„ì§€ëŠ” ê²ƒ ë°©ì§€ */
}

/* === 1. ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ (ì‹ ê·œ ì¶”ê°€) === */
.sidebar-area {
	width: 280px;
	background: #fff;
	border-radius: 20px;
	box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
	padding: 20px;
	display: flex;
	flex-direction: column;
	flex-shrink: 0;
}

.btn-new-chat {
	width: 100%;
	padding: 12px;
	background-color: #5ac4c9;
	color: #fff;
	border: none;
	border-radius: 12px;
	font-weight: 700;
	margin-bottom: 20px;
	transition: 0.2s;
	display: flex;
	justify-content: center;
	align-items: center;
	gap: 8px;
}

.btn-new-chat:hover {
	background-color: #4aa0a5;
}

.history-list {
	flex: 1;
	overflow-y: auto;
	display: flex;
	flex-direction: column;
	gap: 8px;
}

.history-item {
	padding: 12px 15px;
	border-radius: 10px;
	background-color: #f8f9fa;
	color: #555;
	font-size: 14px;
	cursor: pointer;
	transition: 0.2s;
	white-space: nowrap;
	overflow: hidden;
	text-overflow: ellipsis;
}

.history-item:hover {
	background-color: #e9ecef;
}

.history-item.active {
	background-color: #e6f7ff;
	color: #5ac4c9;
	font-weight: bold;
	border: 1px solid #5ac4c9;
}

/* === 2. ë©”ì¸ ì¸í„°í˜ì´ìŠ¤ (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ + Flex ì¡°ì •) === */
.main-interface-card {
	flex: 1; /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
	background: #ffffff;
	border-radius: 20px;
	box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
	display: flex;
	flex-direction: column;
	height: 100%; /* ë¶€ëª¨ ë†’ì´ ìƒì† */
	overflow: hidden;
}

/* ì±„íŒ… ì˜ì—­ (ë‚´ë¶€ ìŠ¤í¬ë¡¤) */
#chatBox {
	background-color: #fff;
	padding: 40px 30px;
	overflow-y: auto; /* ìŠ¤í¬ë¡¤ í™œì„±í™” */
	flex: 1; /* ê°€ë³€ ë†’ì´ */
}

/* ë§í’ì„  ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) */
.msgContent {
	display: inline-block;
	padding: 12px 20px;
	border-radius: 18px;
	max-width: 80%;
	text-align: left;
	font-size: 16px;
	line-height: 1.6;
}

.receiveMsg {
	text-align: left;
	margin-bottom: 25px;
}

.receiveMsg .msgContent {
	background-color: #f1f3f5;
	color: #333;
	border-radius: 4px 18px 18px 18px;
}

.sendMsg {
	text-align: end;
	margin-bottom: 25px;
}

.sendMsg .msgContent {
	background-color: #5ac4c9;
	color: #fff;
	border-radius: 18px 4px 18px 18px;
	font-weight: 500;
}

/* ì˜µì…˜ ì˜ì—­ (ê¸°ì¡´ ìœ ì§€) */
#recommendationFormContainer {
	background-color: #fcfcfc;
	padding: 30px;
	border-top: 2px solid #f1f3f5;
	border-bottom: 1px solid #eee;
	flex-shrink: 0; /* í¬ê¸° ê³ ì • */
}

.selection-label {
	color: #555;
	font-weight: 700;
	font-size: 15px;
	margin-bottom: 10px;
	display: block;
}

.selection-group {
	display: flex;
	flex-wrap: wrap;
	gap: 8px;
	margin-bottom: 0;
}

.btn-option {
	background-color: #fff;
	border: 1px solid #ddd;
	border-radius: 20px;
	padding: 8px 16px;
	font-size: 14px;
	color: #555;
	cursor: pointer;
	transition: all 0.2s ease;
	outline: none;
	font-weight: 500;
}

.btn-option:hover {
	background-color: #f8f9fa;
	border-color: #ccc;
	color: #333;
}

.btn-option.active {
	background-color: #5ac4c9;
	border-color: #5ac4c9;
	color: #fff;
	font-weight: 700;
	box-shadow: 0 2px 5px rgba(90, 196, 201, 0.3);
}

.btn-option:disabled {
	opacity: 0.5;
	cursor: not-allowed;
}

input[type="date"] {
	border: 1px solid #ddd;
	border-radius: 8px;
	padding: 6px 12px;
	color: #555;
	font-family: 'Noto Sans KR', sans-serif;
	font-size: 14px;
	width: 100%;
}

/* ì…ë ¥ì°½ ì˜ì—­ (ê¸°ì¡´ ìœ ì§€) */
.input-area-wrapper {
	background-color: #fff;
	padding: 20px 30px 30px 30px;
	flex-shrink: 0;
}

#fh5co-subscribe {
	position: relative;
	background: #f8f9fa;
	border-radius: 30px;
	padding: 5px;
	border: 1px solid #e9ecef;
	display: flex;
	align-items: center;
}

#fh5co-subscribe .form-group {
	width: 100%;
	margin-bottom: 0;
	display: flex;
	align-items: center;
}

#fh5co-subscribe .form-control {
	width: 100%;
	background-color: transparent;
	border: none;
	color: #333;
	border-radius: 30px;
	padding: 12px 20px;
	height: auto;
	font-size: 15px;
	box-shadow: none;
}

#fh5co-subscribe .form-control:focus {
	outline: none;
	box-shadow: none;
}

#fh5co-subscribe .btn-primary {
	background-color: #5ac4c9;
	border-color: #5ac4c9;
	border-radius: 25px;
	padding: 10px 25px;
	margin-right: 5px;
	font-weight: bold;
	color: #fff;
	border: none;
	transition: background-color 0.3s;
	white-space: nowrap;
	height: auto;
}

#fh5co-subscribe .btn-primary:hover {
	background-color: #4aa0a5;
}

/* ì¶”ì²œ ì¹´ë“œ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) */
.recommendation-container {
	display: flex;
	flex-direction: row;
	flex-wrap: wrap;
	gap: 20px;
	margin-top: 20px;
	width: 100%;
}

.recommendation-card {
	background-color: #fff;
	border: 1px solid #eee;
	border-radius: 20px;
	padding: 30px;
	box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
	flex: 1 1 300px;
	min-width: 300px;
	position: relative;
	overflow: hidden;
}

.recommendation-card::before {
	content: '';
	position: absolute;
	left: 0;
	top: 0;
	bottom: 0;
	width: 8px;
	background-color: #5ac4c9;
}

.rec-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 20px;
	border-bottom: 1px solid #f0f0f0;
	padding-bottom: 15px;
}

.rec-city {
	font-size: 20px;
	font-weight: 700;
	color: #222;
}

.rec-country {
	font-size: 14px;
	color: #5ac4c9;
	background: rgba(90, 196, 201, 0.1);
	padding: 5px 12px;
	border-radius: 15px;
}

.rec-body p {
	font-size: 16px;
	color: #555;
	line-height: 1.8;
	margin-bottom: 20px;
	word-break: keep-all;
}

.rec-activities {
	background-color: #f9fbfb;
	padding: 20px;
	border-radius: 15px;
	margin-bottom: 20px;
}

.rec-activities strong {
	display: block;
	margin-bottom: 12px;
	font-size: 16px;
	color: #333;
}

.rec-activities ul {
	margin: 0;
	padding-left: 20px;
}

.rec-activities li {
	font-size: 15px;
	color: #666;
	margin-bottom: 8px;
	line-height: 1.6;
}

.btn-flight-search {
	display: block;
	width: 100%;
	margin-top: 25px;
	padding: 15px;
	background-color: #5ac4c9;
	color: #fff;
	border: none;
	border-radius: 12px;
	font-weight: bold;
	cursor: pointer;
	font-size: 16px;
	transition: background-color 0.3s;
}

.btn-flight-search:hover {
	background-color: #4aa0a5;
	text-decoration: none;
	color: #fff;
}

/* ë¡œë”©, ê¸°íƒ€ ìœ í‹¸ (ê¸°ì¡´ ìœ ì§€) */
#newSearchContainer {
	padding: 15px 30px;
	background-color: #fff;
	border-top: 1px solid #eee;
	text-align: center;
}

#newSearchContainer .btn-new-search {
	background-color: #6c757d;
	color: #fff;
	border: none;
	border-radius: 25px;
	padding: 10px 20px;
	font-weight: bold;
	cursor: pointer;
	transition: 0.3s;
	font-size: 14px;
}

#flightSearchLoadingModal {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background-color: rgba(0, 0, 0, 0.6);
	z-index: 2000;
	display: none;
	justify-content: center;
	align-items: center;
	flex-direction: column;
	color: #fff;
	backdrop-filter: blur(4px);
}

#flightSearchLoadingModal .spinner-large {
	width: 50px;
	height: 50px;
	border: 5px solid #f3f3f3;
	border-top: 5px solid #5ac4c9;
	border-radius: 50%;
	animation: spin 1s linear infinite;
	margin-bottom: 15px;
}

.spinner {
	display: inline-block;
	width: 16px;
	height: 16px;
	border: 2px solid rgba(0, 0, 0, .1);
	border-radius: 50%;
	border-top-color: #5ac4c9;
	animation: spin 1s ease-in-out infinite;
	margin-right: 8px;
	vertical-align: middle;
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}
</style>
</head>
<body>
	<div id="flightSearchLoadingModal">
		<div class="spinner-large"></div>
		<p>í•­ê³µê¶Œ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘ì…ë‹ˆë‹¤...</p>
	</div>

	<header
		th:replace="layout/header_fragment :: common-header(activeMenu='chat')"></header>

	<div class="chat-layout-wrapper">

		<aside class="sidebar-area">
			<button class="btn-new-chat" onclick="startNewChat()">
				<i class="bi bi-plus-lg"></i> ìƒˆë¡œìš´ ì±„íŒ…
			</button>
			<div class="history-list" id="historyList">
				<div
					style="text-align: center; color: #999; margin-top: 20px; font-size: 13px;">
					<div class="spinner"></div>
					ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
				</div>
			</div>
		</aside>

		<main class="main-interface-card">

			<div id="chatBox">
			<div class="receiveMsg">
                <div class="msgContent">
                    ì•ˆë…•í•˜ì„¸ìš”! 'ë¬´ì„±ì˜ ì—¬í–‰'ì…ë‹ˆë‹¤. âœˆï¸<br>
                    ì–´ë–¤ ì—¬í–‰ì„ ê³„íší•˜ê³  ê³„ì‹ ê°€ìš”?
                </div>
            </div>
			</div>

			<div id="recommendationFormContainer">
				<input type="hidden" id="selectDeparture" value="ICN"> <input
					type="hidden" id="selectRegion" value="any"> <input
					type="hidden" id="selectTheme" value="any"> <input
					type="hidden" id="selectDuration" value="any"> <input
					type="hidden" id="selectBudget" value="any">

				<div class="row" style="margin-bottom: 15px;">
					<div class="col-md-6 col-12 mb-3 mb-md-0">
						<label class="selection-label">ğŸ›« ì–´ë””ì„œ ì¶œë°œí•˜ì‹œë‚˜ìš”?</label>
						<div class="selection-group" id="groupDeparture">
							<button type="button" class="btn-option active" data-value="ICN">ì¸ì²œ</button>
							<button type="button" class="btn-option" data-value="GMP">ê¹€í¬</button>
							<button type="button" class="btn-option" data-value="PUS">ê¹€í•´</button>
							<button type="button" class="btn-option" data-value="CJU">ì œì£¼</button>
							<button type="button" class="btn-option" data-value="TAE">ëŒ€êµ¬</button>
							<button type="button" class="btn-option" data-value="RSU">ì—¬ìˆ˜</button>
						</div>
					</div>
					<div class="col-md-6 col-12">
						<label class="selection-label" for="inputDateUI">ğŸ“… ì–¸ì œ
							ë– ë‚˜ì‹œë‚˜ìš”?</label> <input type="date" id="inputDateUI">
					</div>
				</div>

				<div class="row" style="margin-bottom: 15px;">
					<div class="col-md-6 col-12 mb-3 mb-md-0">
						<label class="selection-label">ğŸŒ ì–´ë””ë¡œ ê°€ê³  ì‹¶ìœ¼ì„¸ìš”?</label>
						<div class="selection-group" id="groupRegion">
							<button type="button" class="btn-option active" data-value="any">ì–´ë””ë“ 
								ì¢‹ì•„ìš”</button>
							<button type="button" class="btn-option" data-value="asia">ì•„ì‹œì•„</button>
							<button type="button" class="btn-option" data-value="europe">ìœ ëŸ½</button>
							<button type="button" class="btn-option" data-value="america">ë¯¸ì£¼</button>
							<button type="button" class="btn-option" data-value="oceania">ì˜¤ì„¸ì•„ë‹ˆì•„</button>
							<button type="button" class="btn-option" data-value="korea">êµ­ë‚´</button>
						</div>
					</div>
					<div class="col-md-6 col-12">
						<label class="selection-label">ğŸ¡ ì–´ë–¤ ì—¬í–‰ì„ ì›í•˜ì„¸ìš”?</label>
						<div class="selection-group" id="groupTheme">
							<button type="button" class="btn-option active" data-value="any">ìƒê´€ì—†ì–´ìš”</button>
							<button type="button" class="btn-option" data-value="healing">ğŸ
								íœ´ì–‘/íë§</button>
							<button type="button" class="btn-option" data-value="food">ğŸœ
								ë¯¸ì‹</button>
							<button type="button" class="btn-option" data-value="tour">ğŸ°
								ê´€ê´‘</button>
							<button type="button" class="btn-option" data-value="activity">ğŸ„
								ì•¡í‹°ë¹„í‹°</button>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col-md-6 col-12 mb-3 mb-md-0">
						<label class="selection-label">ğŸŒ™ ì—¬í–‰ ê¸°ê°„ì€?</label>
						<div class="selection-group" id="groupDuration">
							<button type="button" class="btn-option active" data-value="any">ìƒê´€ì—†ì–´ìš”</button>
							<button type="button" class="btn-option" data-value="1-2">1ë°•
								2ì¼</button>
							<button type="button" class="btn-option" data-value="2-3">2ë°•
								3ì¼</button>
							<button type="button" class="btn-option" data-value="3-4">3ë°•
								4ì¼</button>
							<button type="button" class="btn-option" data-value="4-5">4ë°•
								5ì¼</button>
							<button type="button" class="btn-option" data-value="long">6ì¼
								ì´ìƒ</button>
						</div>
					</div>
					<div class="col-md-6 col-12">
						<label class="selection-label">ğŸ’° 1ì¸ë‹¹ ì˜ˆì‚°ì€?</label>
						<div class="selection-group" id="groupBudget">
							<button type="button" class="btn-option active" data-value="any">ìƒê´€ì—†ì–´ìš”</button>
							<button type="button" class="btn-option" data-value="low">50ë§Œì›
								â†“</button>
							<button type="button" class="btn-option" data-value="medium">50~100ë§Œ</button>
							<button type="button" class="btn-option" data-value="high">100~200ë§Œ</button>
							<button type="button" class="btn-option" data-value="luxury">200ë§Œì›
								â†‘</button>
						</div>
					</div>
				</div>
			</div>

			<div id="newSearchContainer" style="display: none;">
				<button id="btnNewSearch" class="btn-new-search">ğŸ”„ ìƒˆë¡œìš´ ì—¬í–‰
					ì¶”ì²œë°›ê¸°</button>
			</div>

			<div class="input-area-wrapper">
				<form id="fh5co-subscribe">
					<div class="form-group">
						<input type="text" class="form-control"
							placeholder="ì¶”ê°€ ìš”ì²­ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì¡°ìš©í•œ ê³³ì´ ì¢‹ì•„)">
						<button type="submit" class="btn btn-primary" id="btnSendChat">
							ì „ì†¡ âœˆï¸</button>
					</div>
				</form>
			</div>
		</main>
	</div>

	<script src="js/jquery.min.js"></script>
	<script src="js/jquery.easing.1.3.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/jquery.waypoints.min.js"></script>
	<script src="js/simplyCountdown.js"></script>
	<script src="js/main.js"></script>
	<script type="text/javascript"
		src="/webjars/sockjs-client/1.5.1/sockjs.js"></script>
	<script type="text/javascript"
		src="/webjars/stomp-websocket/2.3.4/stomp.js"></script>

	<script>
    let stompClient = null;
    let currentRoomId = null; // í˜„ì¬ ë°© ID
    let chatMode = 'recommend'; 
    let localConversationHistory = []; // ë¬¸ë§¥ ìœ ì§€ìš©

    const chatBox = document.getElementById('chatBox');
    const historyList = document.getElementById('historyList');
    const messageInput = document.querySelector('#fh5co-subscribe .form-control');
    const sendButton = document.getElementById('btnSendChat'); 
    const newSearchButton = document.getElementById('btnNewSearch');
    const flightSearchLoadingModal = document.getElementById('flightSearchLoadingModal');

    // ì¶œë°œì§€ë³„ ì„ íƒ ê°€ëŠ¥í•œ ì§€ì—­
    const departurePermissions = {
        'ICN': ['any', 'asia', 'europe', 'america', 'oceania', 'korea'],
        'GMP': ['asia', 'korea'],
        'PUS': ['asia', 'korea'],
        'CJU': ['asia', 'korea'],
        'TAE': ['korea'],
        'RSU': ['korea']
    };

    document.addEventListener('DOMContentLoaded', () => {
        // ë‚ ì§œ ì˜¤ëŠ˜ë¡œ ì„¤ì •
        const dateInput = document.getElementById('inputDateUI');
        if (dateInput) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;
            dateInput.value = todayString;
            dateInput.setAttribute('min', todayString);
        }

        setupOptionButtons();
        updateRegionOptions(); 
        
        // [í•µì‹¬] ì‚¬ì´ë“œë°” ëª©ë¡ ë¡œë“œ
        loadChatRooms();
        
        // ì†Œì¼“ ì—°ê²°
        connect();
    });

    // 1. ì‚¬ì´ë“œë°” ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ (ìˆ˜ì •ë¨)
    async function loadChatRooms() {
        try {
            const res = await fetch('/chat/rooms');
            if(res.ok) {
                const rooms = await res.json();
                renderSidebar(rooms);
            }
        } catch(e) {
            console.error(e);
            historyList.innerHTML = '<div style="padding:15px; text-align:center; font-size:13px; color:#aaa;">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    }

    function renderSidebar(rooms) {
        historyList.innerHTML = '';
        if(!rooms || rooms.length === 0) {
            historyList.innerHTML = '<div style="padding:20px; text-align:center; color:#ccc; font-size:13px;">ê¸°ë¡ ì—†ìŒ</div>';
            return;
        }

        rooms.forEach(room => {
            const div = document.createElement('div');
            div.className = 'history-item';
            if(room.id === currentRoomId) div.classList.add('active');
            
            // ë‚ ì§œëŠ” í¬ë§·íŒ… (YYYY-MM-DD ë§Œ í‘œì‹œí•˜ê±°ë‚˜ ì œê±° ê°€ëŠ¥)
            // ì œëª©(Region - Theme)ì„ ê°•ì¡°í•´ì„œ ë³´ì—¬ì¤Œ
            div.innerHTML = `
                <div style="font-weight:700; font-size:15px; color:#333; margin-bottom:4px;">
                    ${room.title}
                </div>
                <div style="font-size:12px; color:#888;">
                    ${room.date ? room.date.split(' ')[0] : 'ë‚ ì§œ ì—†ìŒ'}
                </div>
            `;
            
            div.onclick = () => loadRoomChat(room.id);
            historyList.appendChild(div);
        });
    }

    // 2. íŠ¹ì • ì±„íŒ…ë°© í´ë¦­ ì‹œ ë‚´ìš© ë¡œë“œ
    async function loadRoomChat(roomId) {
        if(currentRoomId === roomId) return;
        currentRoomId = roomId;

        chatBox.innerHTML = '';
        setChatMode('follow-up'); // ê¸°ì¡´ ëŒ€í™”ëŠ” ë°”ë¡œ ì§ˆë¬¸ ëª¨ë“œ
        
        // ì‚¬ì´ë“œë°” UI ê°±ì‹ 
        document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
        // active í´ë˜ìŠ¤ ë‹¤ì‹œ ë¶€ì—¬ë¥¼ ìœ„í•´ ëª©ë¡ ì¬ë¡œë“œ (ê°„í¸í•¨)
        loadChatRooms();

        try {
            const res = await fetch('/chat/messages?roomId=' + roomId);
            const messages = await res.json();
            
            // ë¬¸ë§¥ ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ìŒ“ê¸°
            localConversationHistory = [];

            messages.forEach(msg => {
                // ë¬¸ë§¥ì— ì¶”ê°€
                if(msg.sender === 'AI') {
                    try {
                        const data = JSON.parse(msg.content);
                        displayMessage('AI', data);
                        localConversationHistory.push({ sender: "AI", content: msg.content });
                    } catch(e) {
                        displayMessage('AI', { chat_response: msg.content });
                        localConversationHistory.push({ sender: "AI", content: msg.content });
                    }
                } else {
                    displayMessage('user', msg.content);
                    localConversationHistory.push({ sender: "user", content: msg.content });
                }
            });
            scrollToBottom();
        } catch(e) {
            console.error(e);
        }
    }

    // 3. ìƒˆ ì±„íŒ… ì‹œì‘
    function startNewChat() {
        currentRoomId = null;
        localConversationHistory = [];
        chatBox.innerHTML = `
            <div class="receiveMsg">
                <div class="msgContent">
                    ì•ˆë…•í•˜ì„¸ìš”! 'ë¬´ì„±ì˜ ì—¬í–‰'ì…ë‹ˆë‹¤. âœˆï¸<br>
                    ì–´ë–¤ ì—¬í–‰ì„ ê³„íší•˜ê³  ê³„ì‹ ê°€ìš”?
                </div>
            </div>`;
        setChatMode('recommend');
        document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
    }

 // 4. ì†Œì¼“ ì—°ê²° í•¨ìˆ˜ ìˆ˜ì •
    function connect() {
        const socket = new SockJS('/ws-chatin');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            stompClient.subscribe('/user/queue/reply', function(message) {
                const payload = JSON.parse(message.body);
                
                // [ì¤‘ìš”] ì²« ì§ˆë¬¸ ì‹œ ë°© ìƒì„±ëœ ê²½ìš° ID ì—…ë°ì´íŠ¸
                if(currentRoomId === null && payload.roomId) {
                    currentRoomId = payload.roomId;
                    loadChatRooms(); // ì‚¬ì´ë“œë°” ê°±ì‹ 
                }

                // ============================================================
                // [ì¶”ê°€ëœ ì½”ë“œ] AI ì‘ë‹µì´ ì˜¤ë©´ ì¦‰ì‹œ 'ì§ˆë¬¸ ëª¨ë“œ'ë¡œ ë³€ê²½í•˜ì—¬ ì¡°ê±´ì°½ ìˆ¨ê¹€
                // ============================================================
                if (chatMode === 'recommend') {
                    setChatMode('follow-up'); 
                }
                // ============================================================

                try {
                    const aiData = JSON.parse(payload.content);
                    displayMessage('AI', aiData);
                    localConversationHistory.push({ sender: "AI", content: payload.content });
                } catch(e) {
                    displayMessage('AI', { chat_response: payload.content });
                    localConversationHistory.push({ sender: "AI", content: payload.content });
                }
                
                // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                const loaders = document.querySelectorAll('.loading-msg');
                loaders.forEach(l => l.remove());
                
                // ìŠ¤í¬ë¡¤ ìµœí•˜ë‹¨ìœ¼ë¡œ ì´ë™
                setTimeout(scrollToBottom, 100); 
            });
        });
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => { if(e.key==='Enter') { e.preventDefault(); sendMessage(e); }});

    function sendMessage(event) {
        if(event) event.preventDefault();
        const text = messageInput.value.trim();
        
        if(chatMode === 'recommend' && text === '') { /* íŒ¨ìŠ¤ */ }
        else if(text === '') return;

        let contentToSend = text;
        
        // [ì¤‘ìš”] ë©”ì‹œì§€ í˜•ì‹ì„ 'í‚¤: ê°’' í˜•íƒœë¡œ ë³€ê²½í•˜ì—¬ ì„œë²„ê°€ íŒŒì‹±í•˜ê¸° ì‰½ê²Œ ë§Œë“¦
        if(chatMode === 'recommend') {
            const date = document.getElementById('inputDateUI').value;
            if(!date) { alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
            
            const getVal = (id) => document.querySelector(`#${id} .active`)?.textContent || 'ì„ íƒì•ˆí•¨';
            
            // ë³€ê²½ëœ í¬ë§·: "ì§€ì—­: ì•„ì‹œì•„, í…Œë§ˆ: íë§" í˜•íƒœë¡œ ì „ì†¡
            contentToSend = `[ì¡°ê±´] ì¶œë°œì§€: ${getVal('groupDeparture')}, ë‚ ì§œ: ${date}, ì§€ì—­: ${getVal('groupRegion')}, í…Œë§ˆ: ${getVal('groupTheme')}, ê¸°ê°„: ${getVal('groupDuration')}, ì˜ˆì‚°: ${getVal('groupBudget')} \n[ì¶”ê°€ìš”ì²­] ${text}`;
        }

        if(text) displayMessage('user', text);
        messageInput.value = '';

        chatBox.insertAdjacentHTML('beforeend', `<div class="receiveMsg loading-msg"><div class="msgContent"><div class="spinner"></div> ì‘ì„± ì¤‘...</div></div>`);
        scrollToBottom();

        localConversationHistory.push({ sender: "user", content: contentToSend });

        const payload = {
            roomId: currentRoomId,
            type: chatMode,
            content: contentToSend,
            history: localConversationHistory
        };
        if(stompClient) stompClient.send("/app/sendMessage", {}, JSON.stringify(payload));
    }
    // === UI ìœ í‹¸ë¦¬í‹° (ê¸°ì¡´ ê¸°ëŠ¥ ë³µì›) ===

    function displayMessage(sender, data) {
        const isUser = sender.toLowerCase() === 'user';
        const className = isUser ? 'sendMsg' : 'receiveMsg';
        
        let html = '';
        if(isUser) {
            html = data; 
        } else {
            if(data.chat_response) html += `<div>${data.chat_response.replace(/\n/g, '<br>')}</div>`;
            if(data.recommendations) {
                html += `<div class="recommendation-container" style="margin-top:15px;">`;
                data.recommendations.forEach((rec, idx) => {
                    html += `
                        <div class="recommendation-card">
                            <div class="rec-header">
                                <span class="rec-city">${idx+1}. ${rec.city}</span>
                                <span class="rec-country">${rec.country}</span>
                            </div>
                            <p style="font-size:14px; color:#666;">${rec.reason}</p>
                            ${rec.activities ? `<div class="rec-activities"><strong>ì¦ê¸¸ê±°ë¦¬:</strong><ul>${rec.activities.map(a=>`<li>${a}</li>`).join('')}</ul></div>` : ''}
                            ${rec.iataCode ? `<button class="btn-flight-search" onclick="searchFlights('${rec.iataCode}','${rec.city}')">âœˆï¸ í•­ê³µê¶Œ ì¡°íšŒ</button>` : ''}
                        </div>`;
                });
                html += `</div>`;
            }
        }

        const div = document.createElement('div');
        div.className = className;
        div.innerHTML = `<div class="msgContent">${html}</div>`;
        chatBox.appendChild(div);
        scrollToBottom();
    }

    function setChatMode(mode) {
        chatMode = mode;
        const form = document.getElementById('recommendationFormContainer');
        const newBtn = document.getElementById('newSearchContainer');
        
        if(mode === 'recommend') {
            form.style.display = 'block';
            newBtn.style.display = 'none';
            messageInput.placeholder = 'ì¶”ê°€ ìš”ì²­ì‚¬í•­ (ì˜ˆ: ì¡°ìš©í•œ ê³³ì´ ì¢‹ì•„)';
        } else {
            form.style.display = 'none';
            newBtn.style.display = 'block';
            messageInput.placeholder = 'ì¶”ì²œ ì—¬í–‰ì§€ì— ëŒ€í•´ ë¬¼ì–´ë³´ì„¸ìš”...';
        }
    }

    newSearchButton.addEventListener('click', () => {
        setChatMode('recommend');
    });

    // [ì¤‘ìš”] ì˜µì…˜ ë²„íŠ¼ ì„¤ì • (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    function setupOptionButtons() {
        const groups = [
            { groupId: 'groupDeparture', inputId: 'selectDeparture', callback: updateRegionOptions }, 
            { groupId: 'groupRegion', inputId: 'selectRegion' },
            { groupId: 'groupTheme', inputId: 'selectTheme' },
            { groupId: 'groupDuration', inputId: 'selectDuration' },
            { groupId: 'groupBudget', inputId: 'selectBudget' }
        ];

        groups.forEach(group => {
            const container = document.getElementById(group.groupId);
            if(!container) return;
            const buttons = container.querySelectorAll('.btn-option');
            buttons.forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.disabled || this.classList.contains('disabled')) return;
                    buttons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(group.inputId).value = this.getAttribute('data-value');
                    if (group.callback) group.callback();
                });
            });
        });
    }

    function updateRegionOptions() {
        const dep = document.getElementById('selectDeparture').value;
        const allow = departurePermissions[dep] || [];
        const regionContainer = document.getElementById('groupRegion');
        const regionButtons = regionContainer.querySelectorAll('.btn-option');
        
        let isCurrentSelectionInvalid = false;

        regionButtons.forEach(btn => {
            const val = btn.getAttribute('data-value');
            if(allow.includes(val)) {
                btn.disabled = false;
                btn.classList.remove('disabled');
            } else {
                btn.disabled = true;
                btn.classList.add('disabled');
                if(btn.classList.contains('active')) {
                    isCurrentSelectionInvalid = true;
                    btn.classList.remove('active');
                }
            }
        });

        if (isCurrentSelectionInvalid) {
            const firstValidBtn = Array.from(regionButtons).find(b => !b.disabled);
            if (firstValidBtn) {
                firstValidBtn.classList.add('active');
                document.getElementById('selectRegion').value = firstValidBtn.getAttribute('data-value');
            }
        }
    }

    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    
    // [ì¤‘ìš”] í•­ê³µê¶Œ ê²€ìƒ‰ (ê¸°ì¡´ ë¡œì§ ë³µì›)
    function searchFlights(arrivalCode, arrivalCityName) {
        if (flightSearchLoadingModal) flightSearchLoadingModal.style.display = 'flex';
        
        const departureSelect = document.getElementById('selectDeparture');
        const departureDate = document.getElementById('inputDateUI').value; 
        const durationText = document.querySelector('#groupDuration .btn-option.active').textContent;
        const departureCode = departureSelect.value;
        const departureKoLocation = document.querySelector('#groupDeparture .btn-option.active').textContent;

        let returnDate = "";
        let tripType = "one-way";

        if (durationText !== "ìƒê´€ì—†ì–´ìš”" && durationText !== "any") {
            const nights = parseInt(durationText.match(/\d+/)?.[0]);
            if (!isNaN(nights)) {
                const date = new Date(departureDate);
                date.setDate(date.getDate() + nights);
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                returnDate = `${year}-${month}-${day}`;
                tripType = "round-trip";
            }
        }

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/air/searchAirport';

        const params = {
            departureCode, arrivalCode, departureDate, returnDate, tripType,
            adults: "1", children: "0", infants: "0", travelClass: "ECONOMY",
            directFlight: "false", departureKoLocation, arrivalKoLocation: arrivalCityName
        };

        for (const key in params) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = params[key];
            form.appendChild(input);
        }

        document.body.appendChild(form);
        form.submit();
    }

    window.onbeforeunload = function() {
        if (stompClient !== null) stompClient.disconnect();
    };
    </script>
</body>
</html>