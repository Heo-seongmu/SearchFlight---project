<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>ë¬´ì„±ì˜ ì—¬í–‰ - í•­ê³µê¶Œ ì„ íƒ(í¸ë„)</title>

<!-- ê³µí†µ í—¤ë“œ (í°íŠ¸, ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë“±) ê°€ì ¸ì˜¤ê¸° -->
<th:block th:replace="layout/header_fragment :: common-head"></th:block>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700,800" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">

<style type="text/css">

.moana_gnb a {
    text-decoration: none !important;
}

body {
    background-color: #f8f9fa; /* í˜ì´ì§€ ë°°ê²½ìƒ‰ ìœ ì§€ */
}

/* --- í¸ë„ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ --- */

.filter-card-button {
	text-align: left;
	width: 100%;
	border: 1px solid #dee2e6;
	border-radius: 0.375rem;
	background-color: #fff;
	padding: 1.25rem;
	transition: box-shadow .15s ease-in-out;
}

.filter-card-button:hover {
	box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.flight-card-button {
	text-align: left;
	border-width: 1px;
	transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
}

.flight-card-button:hover {
	border-color: #5ac4c9;
	box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
}

.flight-card-button .card-body {
	padding: 1.5rem;
}

.price-display {
	font-size: 1.5rem;
	font-weight: 700;
	letter-spacing: -1px;
}

.flight-search-form .form-label {
	display: block;
	font-size: 0.875rem;
	color: #6c757d;
	margin-bottom: 0.3rem;
}

.flight-search-form .nav-tabs {
	border-bottom: 1px solid #dee2e6;
}

.flight-search-form .nav-tabs .nav-link-label {
	padding: 0.5rem 0.8rem;
	cursor: pointer;
	border-bottom: 3px solid transparent;
	color: #6c757d;
	margin-bottom: -1px;
}

.flight-search-form input[type="radio"]:checked+.nav-link-label {
	border-color: #0d6efd;
	color: #0d6efd;
	font-weight: 500;
}

.flight-search-form .form-control-like-button {
	display: block;
	width: 100%;
	padding: 0.6rem 0.9rem;
	font-size: 1rem;
	font-weight: 400;
	line-height: 1.5;
	color: #212529;
	background-color: #fff;
	border: 1px solid #ced4da;
	border-radius: 0.375rem;
	text-align: left;
	transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
}

.flight-search-form .form-control-like-button:hover {
	border-color: #86b7fe;
}

#modalDepartureBtn, #modalArrivalBtn {
	text-align: center;
	font-weight: bold;
	font-size: 1.25rem;
}

.flight-search-form .btn-submit {
	padding-top: 0.8rem;
	padding-bottom: 0.8rem;
	font-size: 1.1rem;
	font-weight: bold;
}

.swap-button {
	border: 1px solid #ddd;
	border-radius: 50%;
	width: 32px;
	height: 32px;
	min-width: 32px;
	display: flex;
	justify-content: center;
	align-items: center;
	font-size: 16px;
	color: #555;
	flex-grow: 0;
}

/* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.modal-overlay {
	display: none;
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background-color: rgba(0, 0, 0, 0.4);
	justify-content: center;
	align-items: center;
	z-index: 1060;
}

.modal-overlay .modal-content {
	background-color: white;
	padding: 24px;
	border-radius: 16px;
	box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
	width: 400px;
	max-height: 80vh;
	overflow-y: auto;
	position: relative;
}

.modal-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 20px;
}

.modal-header h2 {
	margin: 0;
	font-size: 20px;
}

.close-button {
	background: none;
	border: none;
	font-size: 24px;
	cursor: pointer;
}

.modal-search-input {
	width: 100%;
	padding: 12px;
	border: 1px solid #ddd;
	border-radius: 8px;
	font-size: 16px;
	box-sizing: border-box;
	margin-bottom: 24px;
}

.popular-searches h3 {
	font-size: 16px;
	color: #555;
	margin-top: 20px;
	margin-bottom: 12px;
}

.tags-container {
	display: flex;
	flex-wrap: wrap;
	gap: 10px;
}

.tag {
	background-color: #f0f0f0;
	color: #333;
	padding: 8px 16px;
	border-radius: 20px;
	font-size: 14px;
	cursor: pointer;
	transition: background-color 0.2s;
}

.tag:hover {
	background-color: #e0e0e0;
}

.search-result-item {
	padding: 10px 5px;
	cursor: pointer;
	border-bottom: 1px solid #f0f0f0;
}

.search-result-item:hover {
	background-color: #f5f5f5;
}

.location-main {
	font-weight: bold;
	font-size: 16px;
}

.location-sub {
	font-size: 14px;
	color: #888;
}

.no-results {
	padding: 20px;
	text-align: center;
	color: #999;
}

.flatpickr-calendar {
	z-index: 1061 !important;
}

.passenger-section, .seat-class-section {
	margin-bottom: 24px;
}

.passenger-section h4, .seat-class-section h4 {
	margin-top: 0;
	margin-bottom: 12px;
	font-size: 16px;
	color: #333;
}

.passenger-row {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 16px;
}

.passenger-label small {
	color: #888;
	font-size: 12px;
}

.passenger-controls {
	display: flex;
	align-items: center;
	gap: 15px;
}

.passenger-controls .count {
	font-size: 18px;
	width: 25px;
	text-align: center;
}

.control-btn {
	width: 32px;
	height: 32px;
	border-radius: 50%;
	border: 1px solid #ddd;
	background-color: white;
	font-size: 20px;
	cursor: pointer;
	color: #3d5aee;
}

.control-btn:disabled {
	color: #ccc;
	cursor: not-allowed;
}

.seat-class-options {
	display: grid;
	grid-template-columns: 1fr 1fr;
	gap: 10px;
}

.seat-class-options label {
	display: flex;
	align-items: center;
	gap: 5px;
	font-size: 14px;
}

.confirm-btn {
	width: 100%;
	padding: 14px;
	background-color: #3d5aee;
	color: white;
	border: none;
	border-radius: 8px;
	font-size: 16px;
	font-weight: bold;
	cursor: pointer;
}

#loadingModal {
	display: none;
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background-color: rgba(0, 0, 0, 0.6);
	z-index: 2000;
	justify-content: center;
	align-items: center;
	flex-direction: column;
	color: white;
}

.spinner {
	width: 50px;
	height: 50px;
	border: 5px solid #f3f3f3;
	border-top: 5px solid #5ac4c9;
	border-radius: 50%;
	animation: spin 1s linear infinite;
	margin-bottom: 20px;
}

#loadingModal p {
	font-size: 18px;
	font-weight: bold;
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}
 
.step-icon {
	width: 36px;
	height: 36px;
	border-radius: 50%;
	background-color: #e9ecef;
	color: #6c757d;
	display: flex;
	align-items: center;
	justify-content: center;
	font-weight: bold;
	margin: 0 auto 8px auto;
}

.step-icon-active {
	background-color: #5ac4c9;
	color: #fff;
}

.step-connector {
	flex-grow: 1;
	height: 3px;
	background-color: #e9ecef;
	margin-top: 16px;
	margin-left: 1rem;
	margin-right: 1rem;
}

/* --- í•„í„° ë° ìŠ¬ë¼ì´ë” --- */
.filter-card {
	border: 1px solid #dee2e6;
	border-radius: 0.375rem;
	background-color: #fff;
	padding: 1.25rem;
}

.filter-label {
	display: flex;
	justify-content: space-between;
	font-size: 0.9rem;
	font-weight: 500;
	color: #555;
}

#duration-slider, #price-slider {
    height: 8px;           /* íŠ¸ë™ ë‘ê»˜ë¥¼ ì¡°ê¸ˆ ë” ë‘ê»ê²Œ */
    margin: 10px 12px 25px 12px; /* ì¢Œìš° ì—¬ë°±ì„ ì£¼ì–´ í•¸ë“¤ ì˜ë¦¼ ë°©ì§€ */
}

/* ìŠ¬ë¼ì´ë” ë°°ê²½ íŠ¸ë™ (íšŒìƒ‰ ë¶€ë¶„) */
.noUi-target {
    background: #e9ecef;
    border-radius: 4px;
    border: none;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); /* ì•ˆìª½ ê·¸ë¦¼ìë¡œ ê¹Šì´ê° ì¶”ê°€ */
}

/* ì„ íƒëœ ë²”ìœ„ (ìƒ‰ìƒ ì±„ì›Œì§€ëŠ” ë¶€ë¶„) - ì‚¬ì´íŠ¸ í…Œë§ˆìƒ‰ ì ìš© */
.noUi-connect {
    background: #5ac4c9; 
}

/* í•¸ë“¤ (ì›€ì§ì´ëŠ” ë™ê·¸ë¼ë¯¸) ë””ìì¸ ë³€ê²½ */
.noUi-handle {
    width: 22px !important;       /* í¬ê¸° í‚¤ì›€ */
    height: 22px !important;
    right: -11px !important;      /* ì¤‘ì•™ ì •ë ¬ ë³´ì • */
    top: -8px !important;         /* íŠ¸ë™ ì¤‘ì•™ì— ì˜¤ë„ë¡ ìœ„ë¡œ ì˜¬ë¦¼ */
    
    border: 2px solid #fff;       /* í°ìƒ‰ í…Œë‘ë¦¬ë¡œ ê¹”ë”í•˜ê²Œ */
    background: #5ac4c9;          /* ë‚´ë¶€ë¥¼ í…Œë§ˆìƒ‰ìœ¼ë¡œ */
    border-radius: 50%;           /* ì™„ë²½í•œ ì›í˜• */
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); /* ê·¸ë¦¼ì ì¶”ê°€ */
    cursor: grab;
    outline: none;
}

/* í•¸ë“¤ì„ ì¡ì•˜ì„ ë•Œ íš¨ê³¼ */
.noUi-handle:active {
    cursor: grabbing;
    transform: scale(1.1);        /* í´ë¦­ ì‹œ ì‚´ì§ ì»¤ì§ */
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
}

/* noUiSlider ê¸°ë³¸ í•¸ë“¤ ë‚´ë¶€ì˜ ì§€ì €ë¶„í•œ ì„  ì œê±° */
.noUi-handle::before,
.noUi-handle::after {
    display: none;
}

/* íˆ´íŒ (ìˆ«ì í‘œì‹œ) ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ (ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ) */
.noUi-tooltip {
    display: none;
}
.btn-group-time-filter {
	display: flex;
	flex-wrap: wrap;
	gap: 8px;
}

.btn-group-time-filter .btn {
	border-radius: 20px;
	padding: 0.25rem 0.75rem;
	font-size: 0.9rem;
	background-color: #f8f9fa;
	border: 1px solid #dee2e6;
	color: #6c757d;
	box-shadow: none !important;
}

.btn-group-time-filter input[type="checkbox"]:checked+.btn {
	background-color: #e7f1ff;
	border-color: #0d6efd;
	color: #0d6efd;
	font-weight: 500;
}

.accordion-item {
	border: 1px solid #dee2e6;
	border-radius: 0.375rem !important;
	margin-bottom: 1rem;
}

.accordion-button {
	font-weight: bold;
	color: #212529;
	background-color: #fff;
	border-radius: 0.375rem !important;
}

.accordion-button:not(.collapsed) {
	background-color: #f8f9fa;
	box-shadow: none;
	color: #0d6efd;
}

.accordion-button:focus {
	box-shadow: none;
	border-color: rgba(0, 0, 0, .125);
}

.accordion-body {
	padding: 1rem 1.25rem;
}

.airline-filter-item {
	display: block;
	margin-bottom: 0.5rem;
}

.airline-filter-item label {
	margin-left: 8px;
	cursor: pointer;
}

/* --- ìƒë‹¨ ë‚ ì§œ/ê°€ê²© ìŠ¤íŠ¸ë¦½ --- */
.date-strip-container {
    display: flex;
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.date-cell {
    flex: 1;
    text-align: center;
    padding: 12px 5px;
    border-right: 1px solid #eee;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    color: #333;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.date-cell:last-child {
    border-right: none;
}

.date-cell:hover {
    background-color: #f8f9fa;
}

.date-cell.active {
    background-color: #0f1e38;
    color: #fff !important;
    border-color: #0f1e38;
}

.date-cell .date-text {
    font-size: 0.85rem;
    margin-bottom: 4px;
    font-weight: 500;
}

.date-cell .price-text {
    font-size: 0.95rem;
    font-weight: 800;
    color: #333;
}

.date-cell.active .price-text {
    color: #5ac4c9; 
}
</style>
</head>
<body>
    <!-- ê³µí†µ í—¤ë” ì ìš© (activeMenu='home') -->
	<header th:replace="layout/header_fragment :: common-header(activeMenu='home')"></header>

	<main class="container py-5">

		<div class="card shadow-sm mb-4">
			<div class="card-body p-4">
				<div class="d-flex justify-content-between align-items-start">
					<div class="text-center">
						<div class="step-icon step-icon-active">1</div>
						<div class="fw-bold text-primary small">í•­ê³µ ì„ íƒ</div>
					</div>
					<div class="step-connector"></div>
					<div class="text-center">
						<div class="step-icon">2</div>
						<div class="text-muted small">íƒ‘ìŠ¹ê° ì •ë³´</div>
					</div>
					<div class="step-connector"></div>
					<div class="text-center">
						<div class="step-icon">3</div>
						<div class="text-muted small">ì˜ˆì•½</div>
					</div>
				</div>
			</div>
		</div>

		<div class="row g-4">

			<div class="col-lg-3">
				<div class="vstack gap-3">

					<button class="filter-card-button" data-bs-toggle="modal"
						data-bs-target="#researchModal"
						th:data-trip-type="${airparmDto.tripType}"
						th:data-departure-code="${airparmDto.departureCode}"
						th:data-arrival-code="${airparmDto.arrivalCode}"
						th:data-departure-date="${airparmDto.departureDate}"
						th:data-return-date="${airparmDto.returnDate}"
						th:data-adults="${airparmDto.adults}"
						th:data-children="${airparmDto.children}"
						th:data-infants="${airparmDto.infants}"
						th:data-travel-class="${airparmDto.travelClass}"
						th:data-departure-ko-location="${airparmDto.departureKoLocation}"
						th:data-arrival-ko-location="${airparmDto.arrivalKoLocation}">
						<div
							class="d-flex justify-content-between align-items-center mb-2">
							<span
								class="badge bg-primary-subtle text-primary-emphasis rounded-pill"
								th:if="${airparmDto.tripType} == 'round-trip'" th:text="ì™•ë³µ">ì™•ë³µ</span>
							<span
								class="badge bg-primary-subtle text-primary-emphasis rounded-pill"
								th:if="${airparmDto.tripType} == 'one-way'" th:text="í¸ë„">í¸ë„</span>
						</div>
						<h5 class="fw-bold mb-1"
							th:text="${airparmDto.departureCode + ' â†” ' + airparmDto.arrivalCode}">
							ì œì£¼ â†” ì˜¤ì‚¬ì¹´ <i class="bi bi-chevron-down"></i>
						</h5>
						<h4 class="fw-bold mb-1"
							th:text="${'('+airparmDto.departureKoLocation + ' â†” ' + airparmDto.arrivalKoLocation + ')'}">
							ì œì£¼ â†” ì˜¤ì‚¬ì¹´ <i class="bi bi-chevron-down"></i>
						</h4>
						<small class="text-body-secondary"
							th:if="${#strings.isEmpty(#strings.trim(airparmDto.returnDate))}"
							th:text="${airparmDto.departureDate}">11.6(ëª©) - 11.8(í† )</small> <small
							class="text-body-secondary"
							th:if="${not #strings.isEmpty(#strings.trim(airparmDto.returnDate))}"
							th:text="${airparmDto.departureDate} + '~' + ${airparmDto.returnDate}">11.6(ëª©)
							- 11.8(í† )</small> <br> <small class="text-body-secondary"
							th:text="'ì„±ì¸ ' + ${airparmDto.adults} + ' ì–´ë¦°ì´ ' + ${airparmDto.children} + ' ìœ ì•„ '
							 + ${airparmDto.infants} + ' Â· ' + ${airparmDto.travelClass} +' class'">ì„±ì¸
							1 Â· ì¼ë°˜ì„</small>
					</button>

					<div class="accordion" id="filterAccordion">

						<div class="accordion-item shadow-sm">
							<h2 class="accordion-header" id="headingTime">
								<button class="accordion-button" type="button"
									data-bs-toggle="collapse" data-bs-target="#collapseTime"
									aria-expanded="true" aria-controls="collapseTime">ì¶œë°œ
									ì‹œê°„ëŒ€ ì„¤ì •</button>
							</h2>
							<div id="collapseTime" class="accordion-collapse collapse show"
								aria-labelledby="headingTime">
								<div class="accordion-body">
									<div class="btn-group-time-filter" role="group"
										aria-label="ì¶œë°œ ì‹œê°„ í•„í„°">
										<input type="checkbox" class="btn-check" name="timeFilter"
											id="time-all" autocomplete="off" checked data-min="0"
											data-max="1439"> <label class="btn" for="time-all">ì „ì²´</label>

										<input type="checkbox" class="btn-check time-filter-option"
											name="timeFilter" id="time-00-04" autocomplete="off"
											data-min="0" data-max="240"> <label class="btn"
											for="time-00-04">00ì‹œ ~ 04ì‹œ</label> <input type="checkbox"
											class="btn-check time-filter-option" name="timeFilter"
											id="time-04-08" autocomplete="off" data-min="240"
											data-max="480"> <label class="btn" for="time-04-08">04ì‹œ
											~ 08ì‹œ</label> <input type="checkbox"
											class="btn-check time-filter-option" name="timeFilter"
											id="time-08-12" autocomplete="off" data-min="480"
											data-max="720"> <label class="btn" for="time-08-12">08ì‹œ
											~ 12ì‹œ</label> <input type="checkbox"
											class="btn-check time-filter-option" name="timeFilter"
											id="time-12-16" autocomplete="off" data-min="720"
											data-max="960"> <label class="btn" for="time-12-16">12ì‹œ
											~ 16ì‹œ</label> <input type="checkbox"
											class="btn-check time-filter-option" name="timeFilter"
											id="time-16-20" autocomplete="off" data-min="960"
											data-max="1200"> <label class="btn" for="time-16-20">16ì‹œ
											~ 20ì‹œ</label> <input type="checkbox"
											class="btn-check time-filter-option" name="timeFilter"
											id="time-20-24" autocomplete="off" data-min="1200"
											data-max="1439"> <label class="btn" for="time-20-24">20ì‹œ
											~ 24ì‹œ</label>
									</div>
								</div>
							</div>
						</div>

						<div class="accordion-item shadow-sm">
							<h2 class="accordion-header" id="headingAirline">
								<button class="accordion-button collapsed" type="button"
									data-bs-toggle="collapse" data-bs-target="#collapseAirline"
									aria-expanded="false" aria-controls="collapseAirline">
									í•­ê³µì‚¬</button>
							</h2>
							<div id="collapseAirline" class="accordion-collapse collapse"
								aria-labelledby="headingAirline">
								<div class="accordion-body">
									<div id="airline-filter-list"></div>
								</div>
							</div>
						</div>

						<div class="accordion-item shadow-sm">
							<h2 class="accordion-header" id="headingDuration">
								<button class="accordion-button collapsed" type="button"
									data-bs-toggle="collapse" data-bs-target="#collapseDuration"
									aria-expanded="false" aria-controls="collapseDuration">
									ì´ ì†Œìš”ì‹œê°„</button>
							</h2>
							<div id="collapseDuration" class="accordion-collapse collapse"
								aria-labelledby="headingDuration">
								<div class="accordion-body">
									<div class="filter-label mb-2">
										<span id="duration-min">0ì‹œê°„ 0ë¶„</span> <span id="duration-max">0ì‹œê°„
											0ë¶„</span>
									</div>
									<div id="duration-slider" class="mx-1"></div>
								</div>
							</div>
						</div>

						<div class="accordion-item shadow-sm">
							<h2 class="accordion-header" id="headingPrice">
								<button class="accordion-button collapsed" type="button"
									data-bs-toggle="collapse" data-bs-target="#collapsePrice"
									aria-expanded="false" aria-controls="collapsePrice">
									ê°€ê²©</button>
							</h2>
							<div id="collapsePrice" class="accordion-collapse collapse"
								aria-labelledby="headingPrice">
								<div class="accordion-body">
									<div class="filter-label mb-2">
										<span id="price-min">0ì›</span> <span id="price-max">0ì›</span>
									</div>
									<div id="price-slider" class="mx-1"></div>
								</div>
							</div>
						</div>

					</div>
				</div>
			</div>

			<div class="col-lg-9">
    <h4 class="fw-bold">ê°€ëŠ”í¸ì„ ì„ íƒí•´ ì£¼ì„¸ìš”</h4>
    <p class="text-body-secondary mb-4">ì„±ì¸ 1ì¸ ê¸°ì¤€, ë°œê¶ŒëŒ€í–‰ìˆ˜ìˆ˜ë£Œ í¬í•¨</p>
    
    <div class="date-strip-container" id="dateStripContainer"></div>

    <div id="flight-list-container">
        
        <div th:if="${#lists.isEmpty(searchairDto)}" class="text-center py-5">
            <p class="text-muted">í•´ë‹¹ ë‚ ì§œì˜ í•­ê³µê¶Œì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>

        <div class="vstack gap-3 flight-item-container" th:each="searchAir : ${searchairDto}">
            <button class="card flight-card-button w-100"
                th:data-offer-id="${searchAir.id}"
                th:data-departure-time="${searchAir.departureTime}"
                th:data-carrier-code="${searchAir.carrierCode}"
                th:data-departure-code="${airparmDto.departureCode}"
                th:data-arrival-code="${airparmDto.arrivalCode}"
                th:data-departure-date="${airparmDto.departureDate}"
                th:data-return-date="${airparmDto.returnDate}"
                th:data-adults="${airparmDto.adults}"
                th:data-children="${airparmDto.children}"
                th:data-infants="${airparmDto.infants}"
                th:data-travel-class="${airparmDto.travelClass}"
                th:data-arrival-time="${searchAir.arrivalTime}"
                th:data-total-price="${searchAir.rawTotalPrice}"
                th:data-origin-code="${searchAir.departureCode}"
                th:data-destination-code="${searchAir.arrivalCode}"
                th:data-departure-ko-location="${airparmDto.departureKoLocation}"
                th:data-arrival-ko-location="${airparmDto.arrivalKoLocation}"
                onclick="selectOneWayFlight(this)">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-5">
                            <small class="text-body-secondary" th:text="${searchAir.numberOfBookableSeats} + 'ì„ ê°€ëŠ¥'">9ì„ ê°€ëŠ¥</small>
                            <div class="d-flex align-items-center mt-1">
                                <div>
                                    <h6 class="fw-bold mb-0 d-flex align-items-center flex-wrap">
                                        <span th:text="${searchAir.departureTime}">16:00</span> 
                                        <small class="text-secondary fw-normal ms-1 me-2" style="font-size: 0.75rem;" th:text="'(' + ${#strings.substring(searchAir.departureDate, 5).replace('-', '.')} + ')'">(11.25) </small> 
                                        <span class="me-2">-</span> 
                                        <span th:text="${searchAir.arrivalTime}">09:30</span> 
                                        <small class="text-secondary fw-normal ms-1" style="font-size: 0.75rem;" th:text="'(' + ${#strings.substring(searchAir.arrivalDate, 5).replace('-', '.')} + ')'">(11.25) </small> 
                                        
                                        <span th:if="${searchAir.dayDifference == 0}" class="badge bg-light text-secondary border rounded-pill ms-2" style="font-size: 0.7rem; font-weight: normal;"> ë‹¹ì¼ </span> 
                                        <small th:if="${searchAir.dayDifference == 0}" class="text-secondary ms-1" style="font-size: 0.7rem;"> <i class="bi bi-info-circle"></i> ì‹œì°¨ë°˜ì˜ </small> 
                                        <span th:if="${searchAir.dayDifference > 0}" class="badge bg-danger-subtle text-danger-emphasis rounded-pill ms-2" style="font-size: 0.7rem;" th:text="'+' + ${searchAir.dayDifference} + 'ì¼'"> +1ì¼ </span> 
                                        <span th:if="${searchAir.dayDifference < 0}" class="badge bg-primary-subtle text-primary-emphasis rounded-pill ms-2" style="font-size: 0.7rem;" th:text="${searchAir.dayDifference} + 'ì¼'"> -1ì¼ </span> 
                                        <small th:if="${searchAir.dayDifference < 0}" class="text-secondary ms-1" style="font-size: 0.7rem;"> <i class="bi bi-info-circle"></i> ì‹œì°¨ë°˜ì˜ </small>
                                    </h6>
                                    <small class="text-body-secondary" th:text="${searchAir.departureCode} + ' â†’ ' + ${searchAir.arrivalCode} + ' Â· ' + ${searchAir.carrierCode} + ' í•­ê³µ'">ICN â†’ SFO Â· UA í•­ê³µ </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 text-md-end">
                            <div class="mb-1"><small class="text-body-secondary"><i class="bi bi-clock"></i> <span th:text="${searchAir.totalDuration}">20ì‹œê°„ 10ë¶„</span></small></div>
                            <span class="fw-bold text-primary" th:if="${searchAir.directFlight}">ì§í•­</span>
                            <div th:unless="${searchAir.directFlight}">
                                <span class="fw-bold text-dark">ê²½ìœ </span> <small class="text-danger d-block fw-bold" style="font-size: 0.8rem;" th:text="${searchAir.layoverNames} + ' ê²½ìœ '">YVR ê²½ìœ </small>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <span class="price-display" th:text="${#numbers.formatInteger(searchAir.rawTotalPrice, 0, 'COMMA')} + 'ì›'">292,050ì›</span>
                        </div>
                    </div>
                    <hr>
                </div>
            </button>
            <br>
        </div>
    </div>
</div>
</div>
	</main>

	<div class="modal fade" id="researchModal" tabindex="-1"
		aria-labelledby="researchModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="researchModalLabel">ì¬ê²€ìƒ‰</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form action="/air/searchAirport" method="GET"
						class="flight-search-form">
						<div class="d-flex nav-tabs mb-4">
							<div>
								<input type="radio" name="tripType" value="round-trip"
									id="modal-round-trip" checked style="display: none;"> <label
									for="modal-round-trip" class="nav-link-label">ì™•ë³µ</label>
							</div>
							<div>
								<input type="radio" name="tripType" value="one-way"
									id="modal-one-way" style="display: none;"> <label
									for="modal-one-way" class="nav-link-label">í¸ë„</label>
							</div>
						</div>
						<div class="d-flex align-items-end justify-content-between mb-4">
							<div class="flex-grow-1">
								<label for="modalDepartureBtn" class="form-label">ì¶œë°œì§€</label>
								<button type="button" id="modalDepartureBtn"
									class="form-control-like-button">SEL</button>
							</div>
							<button type="button" class="swap-button">â†”</button>
							<div class="flex-grow-1">
								<label for="modalArrivalBtn" class="form-label">ë„ì°©ì§€</label>
								<button type="button" id="modalArrivalBtn"
									class="form-control-like-button">CJU</button>
							</div>
						</div>
						<div class="mb-4">
							<label for="modalDateRangeBtn" class="form-label">ë‚ ì§œ</label>
							<button type="button" id="modalDateRangeBtn"
								class="form-control-like-button">2025-10-13 ~
								2025-10-14</button>
						</div>
						<div class="mb-4">
							<label for="passengerBtn" class="form-label">íƒ‘ìŠ¹ê°</label>
							<button type="button" id="passengerBtn"
								class="form-control-like-button">ì„±ì¸ 1 ì–´ë¦°ì´ 0 ìœ ì•„ 0 Â·
								ECONOMY class</button>
						</div>
						<input type="hidden" name="departureCode"
							id="modalDepartureCodeInput"> <input type="hidden"
							name="arrivalCode" id="modalArrivalCodeInput"> <input
							type="hidden" name="departureDate" id="modalDepartureDateInput">
						<input type="hidden" name="returnDate" id="modalReturnDateInput">
						<input type="hidden" name="adults" id="adultsInput"> <input
							type="hidden" name="children" id="childrenInput"> <input
							type="hidden" name="infants" id="infantsInput"> <input
							type="hidden" name="travelClass" id="travelClassInput"> <input
							type="hidden" name="departureKoLocation"
							id="modalDepartureKoLocationInput"> <input type="hidden"
							name="arrivalKoLocation" id="modalArrivalKoLocationInput">
						<div class="d-grid mt-2">
							<button type="submit" class="btn btn-primary btn-lg btn-submit">ê²€ìƒ‰í•˜ê¸°</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="returnFlightListModal" tabindex="-1"
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-scrollable modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">ì˜¤ëŠ” í¸ í•­ê³µê¶Œì„ ì„ íƒí•´ì£¼ì„¸ìš”</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div id="modal-return-flight-list"></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">ë‹«ê¸°</button>
				</div>
			</div>
		</div>
	</div>

	<div id="locationModal" class="modal-overlay">
		<div class="modal-content">
			<div class="modal-header">
				<h2 id="modalTitle">ì¶œë°œì§€ ì„ íƒ</h2>
				<button id="closeModalBtn" class="close-button">&times;</button>
			</div>
			<input type="text" id="searchAir" class="modal-search-input"
				placeholder="êµ­ê°€, ë„ì‹œ ë˜ëŠ” ê³µí•­ìœ¼ë¡œ ì°¾ì•„ë³´ì„¸ìš”">
			<div class="popular-searches">
				<h3>êµ­ë‚´ ì¸ê¸° ê²€ìƒ‰</h3>
				<div class="tags-container">
					<span class="tag" data-iata="ICN">ì„œìš¸/ì¸ì²œ</span> <span class="tag"
						data-iata="CJU">ì œì£¼</span> <span class="tag" data-iata="PUS">ë¶€ì‚°</span>
					<span class="tag" data-iata="GMP">ì„œìš¸/ê¹€í¬</span> <span class="tag"
						data-iata="RSU">ì—¬ìˆ˜</span>
				</div>
				<h3>ë™ë‚¨ì•„ ì¸ê¸° ê²€ìƒ‰</h3>
				<div class="tags-container">
					<span class="tag" data-iata="DAD">ë‹¤ë‚­</span> <span class="tag"
						data-iata="BKK">ë°©ì½•</span> <span class="tag" data-iata="TPE">íƒ€ì´ë² ì´</span>
					<span class="tag" data-iata="HKG">í™ì½©</span> <span class="tag"
						data-iata="DPS">ë°œë¦¬</span>
				</div>
				<h3>ì¼ë³¸ ì¸ê¸° ê²€ìƒ‰</h3>
				<div class="tags-container">
					<span class="tag" data-iata="NRT">ë„ì¿„/ë‚˜ë¦¬íƒ€</span> <span class="tag"
						data-iata="KIX">ì˜¤ì‚¬ì¹´</span> <span class="tag" data-iata="FUK">í›„ì¿ ì˜¤ì¹´</span>
					<span class="tag" data-iata="CTS">ì‚¿í¬ë¡œ/ì‚°ì¹˜í† ì„¸</span> <span class="tag"
						data-iata="OKA">ì˜¤í‚¤ë‚˜ì™€</span>
				</div>
				<h3>ìœ ëŸ½ ì¸ê¸° ê²€ìƒ‰</h3>
				<div class="tags-container">
					<span class="tag" data-iata="CDG">íŒŒë¦¬</span> <span class="tag"
						data-iata="LHR">ëŸ°ë˜</span> <span class="tag" data-iata="FCO">ë¡œë§ˆ</span>
					<span class="tag" data-iata="MAD">ë§ˆë“œë¦¬ë“œ</span> <span class="tag"
						data-iata="BCN">ë°”ë¥´ì…€ë¡œë‚˜</span>
				</div>
				<h3>ë¶ë¯¸ ë° ê¸°íƒ€</h3>
				<div class="tags-container">
					<span class="tag" data-iata="JEK">ë‰´ìš•</span> <span class="tag"
						data-iata="SYD">ì‹œë“œë‹ˆ</span> <span class="tag" data-iata="LAX">ë¡œìŠ¤ì•¤ì ¤ë ˆìŠ¤</span>
					<span class="tag" data-iata="SFO">ìƒŒí”„ë€ì‹œìŠ¤ì½”</span> <span class="tag"
						data-iata="GUM">ê´Œ</span>
				</div>
			</div>
		</div>
	</div>

	<div id="passengerModal" class="modal-overlay">
		<div class="modal-content">
			<div class="modal-header">
				<h2>ì¸ì› ë° ì¢Œì„ ë“±ê¸‰</h2>
				<button class="close-button">&times;</button>
			</div>
			<div class="passenger-section">
				<h4>ì¸ì›</h4>
				<div class="passenger-row" data-type="adult">
					<div class="passenger-label">
						<div>ì„±ì¸</div>
						<small>ë§Œ 12ì„¸ ì´ìƒ</small>
					</div>
					<div class="passenger-controls">
						<button type="button" class="control-btn minus" disabled>-</button>
						<span class="count">1</span>
						<button type="button" class="control-btn plus">+</button>
					</div>
				</div>
				<div class="passenger-row" data-type="child">
					<div class="passenger-label">
						<div>ì†Œì•„</div>
						<small>ë§Œ 2~12ì„¸ ë¯¸ë§Œ</small>
					</div>
					<div class="passenger-controls">
						<button type="button" class="control-btn minus" disabled>-</button>
						<span class="count">0</span>
						<button type="button" class="control-btn plus">+</button>
					</div>
				</div>
				<div class="passenger-row" data-type="infant">
					<div class="passenger-label">
						<div>ìœ ì•„</div>
						<small>ë§Œ 2ì„¸ ë¯¸ë§Œ (ë³´í˜¸ìì™€ ë™ë°˜ ì°©ì„)</small>
					</div>
					<div class="passenger-controls">
						<button type="button" class="control-btn minus" disabled>-</button>
						<span class="count">0</span>
						<button type="button" class="control-btn plus">+</button>
					</div>
				</div>
			</div>
			<div class="seat-class-section">
				<h4>ì¢Œì„ë“±ê¸‰</h4>
				<div class="seat-class-options">
					<label><input type="radio" name="travelClassModal"
						value="ECONOMY" checked> ì¼ë°˜ì„</label><label><input type="radio"
						name="travelClassModal" value="BUSINESS"> ë¹„ì¦ˆë‹ˆìŠ¤ì„</label>
				</div>
			</div>
			<button type="button" id="confirmPassengerBtn" class="confirm-btn">ì„ íƒ
				ì™„ë£Œ</button>
		</div>
	</div>

	<div id="loadingModal">
		<div class="spinner"></div>
		<p>í•­ê³µê¶Œì„ ì¬ê²€ìƒ‰ì¤‘ì…ë‹ˆë‹¤...</p>
	</div>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script
		src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
	<script src="https://npmcdn.com/flatpickr/dist/l10n/ko.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>

	<script th:inline="javascript">
	
    /* ğŸŸ¢ ì„œë²„ì—ì„œ ë„˜ì–´ì˜¨ ë‚ ì§œë³„ ê°€ê²© ë°ì´í„° (Map) */
    const datePriceMap = /*[[${datePriceMap}]]*/ {}; 
    const isLoggedIn = /*[[${session.loginUser != null}]]*/ false; 
    // 1. ì´ˆê¸°í™” ë¡œì§ 
    document.addEventListener('DOMContentLoaded', function() {
        renderDateStrip();
        initFilters(); 
    });

    // 2. ë‚ ì§œ ìŠ¤íŠ¸ë¦½ ë Œë”ë§
    function renderDateStrip() {
        const container = document.getElementById('dateStripContainer');
        const filterBtn = document.querySelector('.filter-card-button');
        if (!container || !filterBtn) return;

        const currentDepDateStr = filterBtn.dataset.departureDate; 
        if (!currentDepDateStr) return;
        
        const parts = currentDepDateStr.split('-');
        const currentDepDate = new Date(parts[0], parts[1] - 1, parts[2]); 

        container.innerHTML = ''; 

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let i = -2; i <= 2; i++) {
            const targetDate = new Date(currentDepDate);
            targetDate.setDate(currentDepDate.getDate() + i);
            targetDate.setHours(0, 0, 0, 0); 
            
            const year = targetDate.getFullYear();
            const month = String(targetDate.getMonth() + 1).padStart(2, '0');
            const day = String(targetDate.getDate()).padStart(2, '0');
            const fullDateStr = `${year}-${month}-${day}`;
            
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const dayName = dayNames[targetDate.getDay()];
            const displayDateStr = `${month}ì›” ${day}ì¼(${dayName})`;
            
            const isActive = (i === 0) ? 'active' : '';
            const isPastDate = targetDate.getTime() < today.getTime();
            const disabledClass = isPastDate ? 'disabled' : '';
            
            let priceText = '-';
            if (datePriceMap && datePriceMap[fullDateStr] && datePriceMap[fullDateStr] !== '-') {
                priceText = datePriceMap[fullDateStr] + ' ~';
            }
            
            const onClickHandler = isPastDate ? '' : `onclick="searchByDate('${fullDateStr}')"`;

            const html = `
                <div class="date-cell ${isActive} ${disabledClass}" ${onClickHandler}>
                    <span class="date-text">${displayDateStr}</span>
                    <span class="price-text" style="font-size: 0.9rem; font-weight: bold;">${priceText}</span> 
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }
    }

    // 3. ë‚ ì§œ í´ë¦­ ì‹œ ì¬ê²€ìƒ‰ (AJAX ë¶€ë¶„ êµì²´)
    async function searchByDate(newDepartureDate) {
        const filterBtn = document.querySelector('.filter-card-button');
        const dataset = filterBtn.dataset;
        const dateCells = document.querySelectorAll('.date-cell');
        
        // UI ì—…ë°ì´íŠ¸ (active ì´ë™)
        dateCells.forEach(cell => {
            cell.classList.remove('active');
            if(cell.getAttribute('onclick') && cell.getAttribute('onclick').includes(newDepartureDate)) {
                 cell.classList.add('active');
            }
        });

        const loadingModal = document.getElementById('loadingModal');
        if (loadingModal) {
            loadingModal.querySelector('p').textContent = 'ì„ íƒí•œ ë‚ ì§œì˜ í•­ê³µê¶Œì„ ì¡°íšŒì¤‘ì…ë‹ˆë‹¤...';
            loadingModal.style.display = 'flex';
        }

        const formData = new FormData();
        formData.append('tripType', dataset.tripType);
        formData.append('departureCode', dataset.departureCode);
        formData.append('arrivalCode', dataset.arrivalCode);
        formData.append('departureKoLocation', dataset.departureKoLocation);
        formData.append('arrivalKoLocation', dataset.arrivalKoLocation);
        formData.append('adults', dataset.adults);
        formData.append('children', dataset.children);
        formData.append('infants', dataset.infants);
        formData.append('travelClass', dataset.travelClass);
        formData.append('departureDate', newDepartureDate); 
        // í¸ë„ë¼ returnDate í•„ìš” ì—†ìŒ
        
        // ğŸŸ¢ ê°€ê²© ì¡°íšŒ ê±´ë„ˆë›°ê¸°
        formData.append('skipPrice', 'true'); 

        try {
            const response = await fetch('/air/searchAirport', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Network response was not ok');

            const htmlText = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            
            // ë¦¬ìŠ¤íŠ¸ êµì²´
            const newFlightList = doc.getElementById('flight-list-container');
            const currentFlightList = document.getElementById('flight-list-container');
            
            if (newFlightList && currentFlightList) {
                currentFlightList.innerHTML = newFlightList.innerHTML;
            }

            // ë°ì´í„° ì—…ë°ì´íŠ¸
            filterBtn.dataset.departureDate = newDepartureDate;
            
            // í•„í„° ì¬ì´ˆê¸°í™”
            initFilters();

        } catch (error) {
            console.error('Error:', error);
            alert('í•­ê³µê¶Œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            if (loadingModal) loadingModal.style.display = 'none';
        }
    }

    // 4. í¸ë„ ì˜ˆì•½ ì´ë™
    function createHiddenInput(form, name, value) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        form.appendChild(input);
    }

    async function selectOneWayFlight(buttonElement) {
    	
    	if (!isLoggedIn) {
            if (confirm("ì˜ˆì•½ì„ ì§„í–‰í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                // í˜„ì¬ í˜ì´ì§€ ì£¼ì†Œ(ê²€ìƒ‰ ê²°ê³¼)ë¥¼ ê°€ì§€ê³  ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                const currentUrl = encodeURIComponent(window.location.href);
                window.location.href = '/member/login?redirectURL=' + currentUrl;
            }
            return; // ë¡œê·¸ì¸ ì•ˆ í–ˆìœ¼ë©´ ì—¬ê¸°ì„œ ë©ˆì¶¤ (í¼ ì „ì†¡ ì•ˆ í•¨)
        }
        const departureInfo = {
            id: buttonElement.dataset.offerId,
            carrierCode: buttonElement.dataset.carrierCode,
            originCode: buttonElement.dataset.originCode,
            destinationCode: buttonElement.dataset.destinationCode,
            departureTime: buttonElement.dataset.departureTime,
            arrivalTime: buttonElement.dataset.arrivalTime,
            totalPrice: parseFloat((buttonElement.dataset.totalPrice || "0").replace(/,/g, '')),
            departureDate: buttonElement.dataset.departureDate,
            departureKoLocation: buttonElement.dataset.departureKoLocation,
            arrivalKoLocation: buttonElement.dataset.arrivalKoLocation
        };
        const passengerInfo = {
            adults: parseInt(buttonElement.dataset.adults, 10),
            children: parseInt(buttonElement.dataset.children, 10),
            infants: parseInt(buttonElement.dataset.infants, 10),
            travelClass: buttonElement.dataset.travelClass
        };

        

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/air/prePsgInfo';

        createHiddenInput(form, 'departureKoLocation', departureInfo.departureKoLocation);
        createHiddenInput(form, 'arrivalKoLocation', departureInfo.arrivalKoLocation);
        createHiddenInput(form, 'adults', passengerInfo.adults);
        createHiddenInput(form, 'children', passengerInfo.children);
        createHiddenInput(form, 'infants', passengerInfo.infants);
        createHiddenInput(form, 'travelClass', passengerInfo.travelClass);

        const departureFlight = {
            id: departureInfo.id,
            carrierCode: departureInfo.carrierCode,
            originCode: departureInfo.originCode,
            destinationCode: departureInfo.destinationCode,
            departureTime: `${departureInfo.departureDate}T${departureInfo.departureTime}:00`,
            arrivalTime: `${departureInfo.departureDate}T${departureInfo.arrivalTime}:00`,
            totalPrice: departureInfo.totalPrice
        };
        for (const key in departureFlight) {
            createHiddenInput(form, `departureFlight.${key}`, departureFlight[key]);
        }
        
        document.body.appendChild(form);
        form.submit();
    }

    // 5. ëª¨ë‹¬ ë° í•„í„° ë¡œì§ (ê³µí†µ)
    const researchModal = document.getElementById('researchModal');
    const modalDateRangeBtn = document.getElementById('modalDateRangeBtn');
    const modalDepartureDateInput = document.getElementById('modalDepartureDateInput');
    const modalReturnDateInput = document.getElementById('modalReturnDateInput');
    const roundTripRadio = document.getElementById('modal-round-trip');
    const oneWayRadio = document.getElementById('modal-one-way');

    const datePicker = flatpickr(modalDateRangeBtn, {
        dateFormat: "Y-m-d", 
        locale: "ko",
        minDate: "today", // ì˜¤ëŠ˜ ì´ì „ ë‚ ì§œ ì„ íƒ ë¹„í™œì„±í™”
        onClose: function(selectedDates, dateStr, instance) {
            const mode = instance.config.mode;
            if (mode === 'range' && selectedDates.length === 2) {
                const startDate = flatpickr.formatDate(selectedDates[0], "Y-m-d");
                const endDate = flatpickr.formatDate(selectedDates[1], "Y-m-d");
                instance.element.textContent = `${startDate} ~ ${endDate}`;
                modalDepartureDateInput.value = startDate;
                modalReturnDateInput.value = endDate;
            } else if (mode === 'single' && selectedDates.length === 1) {
                const selectedDate = flatpickr.formatDate(selectedDates[0], "Y-m-d");
                instance.element.textContent = selectedDate;
                modalDepartureDateInput.value = selectedDate;
                modalReturnDateInput.value = '';
            }
        }
    });
    modalDateRangeBtn.addEventListener('click', (event) => event.preventDefault());

    function updateCalendarMode() {
        datePicker.clear();
        modalDateRangeBtn.textContent = 'ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”';
        modalDepartureDateInput.value = '';
        modalReturnDateInput.value = '';
        datePicker.set('mode', oneWayRadio.checked ? 'single' : 'range');
    }
    roundTripRadio.addEventListener('change', updateCalendarMode);
    oneWayRadio.addEventListener('change', updateCalendarMode);

    researchModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        // ë°ì´í„°ì…‹ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
        const { tripType, departureCode, arrivalCode, departureDate, returnDate, adults, children, infants, travelClass, departureKoLocation, arrivalKoLocation } = button.dataset;
        
        // ìš”ì†Œ ì„ íƒ
        const modalDepartureBtn = researchModal.querySelector('#modalDepartureBtn');
        const modalArrivalBtn = researchModal.querySelector('#modalArrivalBtn');
        const passengerBtn = researchModal.querySelector('#passengerBtn'); 
        const modalDateRangeBtn = document.getElementById('modalDateRangeBtn'); // ë‚ ì§œ ë²„íŠ¼
        
        // 1. ì¥ì†Œ ì •ë³´ ì±„ìš°ê¸°
        modalDepartureBtn.textContent = departureCode;
        modalArrivalBtn.textContent = arrivalCode;
        document.getElementById('modalDepartureCodeInput').value = departureCode;
        document.getElementById('modalArrivalCodeInput').value = arrivalCode;
        document.getElementById('modalDepartureKoLocationInput').value = departureKoLocation;
        document.getElementById('modalArrivalKoLocationInput').value = arrivalKoLocation;
        
        // 2. ë‚ ì§œ ì •ë³´ ì±„ìš°ê¸° (ğŸŸ¢ ì—¬ê¸°ì„œ undefined ë¬¸ì œ í•´ê²°)
        let safeReturnDate = returnDate;
        if (!safeReturnDate || safeReturnDate === 'undefined' || safeReturnDate === 'null') {
            safeReturnDate = ''; // ë¹ˆ ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
        }

        let dateString = departureDate;
        if (tripType === 'round-trip' && safeReturnDate !== '') {
            dateString += ` ~ ${safeReturnDate}`;
        }
        
        modalDateRangeBtn.textContent = dateString;
        document.getElementById('modalDepartureDateInput').value = departureDate;
        document.getElementById('modalReturnDateInput').value = safeReturnDate; // ğŸŸ¢ ì•ˆì „í•œ ê°’ ë„£ê¸°

        // 3. ìŠ¹ê° ì •ë³´ ì±„ìš°ê¸°
        passengerBtn.textContent = `ì„±ì¸ ${adults} ì–´ë¦°ì´ ${children} ìœ ì•„ ${infants} Â· ${travelClass} class`;
        document.getElementById('adultsInput').value = adults;
        document.getElementById('childrenInput').value = children;
        document.getElementById('infantsInput').value = infants;
        document.getElementById('travelClassInput').value = travelClass;

        // 4. ë¼ë””ì˜¤ ë²„íŠ¼ ë° ë‹¬ë ¥ ëª¨ë“œ ì„¤ì •
        if (tripType === 'round-trip') {
            roundTripRadio.checked = true;
            datePicker.set('mode', 'range');
            if(safeReturnDate) datePicker.setDate([departureDate, safeReturnDate]);
        } else {
            oneWayRadio.checked = true;
            datePicker.set('mode', 'single');
            datePicker.setDate([departureDate]);
        }
    });

    // Location & Passenger Modal
    const modalDepartureBtn = document.getElementById('modalDepartureBtn');
    const modalArrivalBtn = document.getElementById('modalArrivalBtn');
    const locationModal = document.getElementById('locationModal');
    const locationModalContent = locationModal.querySelector('.modal-content');
    const popularSearchesContainer = locationModal.querySelector('.popular-searches');
    const defaultModalContentHtml = popularSearchesContainer.innerHTML;
    locationModalContent.addEventListener('mousedown', (event) => event.stopPropagation());
    let locationSelectionContext = null;

    function closeLocationModal() {
        locationModal.style.display = 'none';
        document.getElementById('researchModal').style.display = 'block';
        document.querySelector('.modal-backdrop').style.display = 'block';
    }
    function openLocationModal(context) {
        document.getElementById('researchModal').style.display = 'none';
        document.querySelector('.modal-backdrop').style.display = 'none';
        locationSelectionContext = context;
        locationModalContent.querySelector('#modalTitle').textContent = context.type === 'departure' ? 'ì¶œë°œì§€ ì„ íƒ' : 'ë„ì°©ì§€ ì„ íƒ';
        popularSearchesContainer.innerHTML = defaultModalContentHtml;
        locationModalContent.querySelector('#searchAir').value = "";
        popularSearchesContainer.querySelectorAll('.tag').forEach(tag => tag.addEventListener('click', handleTagClick));
        locationModal.style.display = 'flex';
        locationModalContent.querySelector('#searchAir').focus();
    }
    function selectLocation(kolocation, iataCode) {
        if (!locationSelectionContext) return;
        locationSelectionContext.buttonElement.textContent = iataCode;
        locationSelectionContext.inputElement.value = iataCode;
        locationSelectionContext.koLocationInputElement.value = kolocation;
        closeLocationModal();
    }
    function handleTagClick(event) { selectLocation(event.currentTarget.textContent, event.currentTarget.dataset.iata); }
    function renderSearchResults(airList) {
        let airListHtml = '';
        if (airList && airList.length > 0) {
            airList.forEach(air => { airListHtml += `<div class="search-result-item" data-kolocation="${air.kolocation}" data-iata="${air.iataCode}"><div class="location-main">${air.kolocation} (${air.iataCode})</div><div class="location-sub">${air.enlocation}</div></div>`; });
        } else { airListHtml = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; }
        popularSearchesContainer.innerHTML = airListHtml;
    }
    modalDepartureBtn.addEventListener('click', () => openLocationModal({ type: 'departure', buttonElement: modalDepartureBtn, inputElement: document.getElementById('modalDepartureCodeInput'), koLocationInputElement: document.getElementById('modalDepartureKoLocationInput') }));
    modalArrivalBtn.addEventListener('click', () => openLocationModal({ type: 'arrival', buttonElement: modalArrivalBtn, inputElement: document.getElementById('modalArrivalCodeInput'), koLocationInputElement: document.getElementById('modalArrivalKoLocationInput') }));
    locationModal.addEventListener('click', function(event) {
        if (event.target.id === 'searchAir') return;
        if (event.target.id === 'closeModalBtn' || event.target.classList.contains('close-button') || event.target === locationModal) { closeLocationModal(); return; }
        const resultItem = event.target.closest('.search-result-item');
        if (resultItem) selectLocation(resultItem.dataset.kolocation, resultItem.dataset.iata);
    });
    locationModal.addEventListener('keydown', function(event) {
        if (event.target.id === 'searchAir' && event.key === 'Enter') {
            event.preventDefault();
            $.ajax({ url: "/air/searchAir", type: "get", dataType: "json", data: { "text": event.target.value }, success: (res) => renderSearchResults(res) });
        }
    });
    document.querySelectorAll('#locationModal .tag').forEach(tag => tag.addEventListener('click', handleTagClick));

    const passengerBtn = document.getElementById('passengerBtn');
    const passengerModal = document.getElementById('passengerModal');
    const passengerModalContent = passengerModal.querySelector('.modal-content');
    const confirmPassengerBtn = document.getElementById('confirmPassengerBtn');

    function openPassengerModal() {
        document.getElementById('researchModal').style.display = 'none';
        document.querySelector('.modal-backdrop').style.display = 'none';
        passengerModal.style.display = 'flex';
    }
    function closePassengerModal() {
        passengerModal.style.display = 'none';
        document.getElementById('researchModal').style.display = 'block';
        document.querySelector('.modal-backdrop').style.display = 'block';
    }
    function updateButtonStates() {
        const adults = parseInt(passengerModal.querySelector('.passenger-row[data-type="adult"] .count').textContent);
        const children = parseInt(passengerModal.querySelector('.passenger-row[data-type="child"] .count').textContent);
        const infants = parseInt(passengerModal.querySelector('.passenger-row[data-type="infant"] .count').textContent);
        const total = adults + children + infants;
        
        const adultControls = passengerModal.querySelector('.passenger-row[data-type="adult"]');
        adultControls.querySelector('.plus').disabled = total >= 9;
        adultControls.querySelector('.minus').disabled = (adults <= 1 || adults < infants);
        
        const childControls = passengerModal.querySelector('.passenger-row[data-type="child"]');
        childControls.querySelector('.plus').disabled = total >= 9;
        childControls.querySelector('.minus').disabled = (children <= 0);
        
        const infantControls = passengerModal.querySelector('.passenger-row[data-type="infant"]');
        infantControls.querySelector('.plus').disabled = (total >= 9 || infants >= adults);
        infantControls.querySelector('.minus').disabled = (infants <= 0);
    }
    passengerBtn.addEventListener('click', openPassengerModal);
    passengerModal.addEventListener('click', (event) => { if (event.target === passengerModal || event.target.classList.contains('close-button')) closePassengerModal(); });
    passengerModalContent.addEventListener('click', (event) => {
        const button = event.target;
        if (!button.classList.contains('control-btn') || button.disabled) return;
        const countSpan = button.closest('.passenger-row').querySelector('.count');
        let count = parseInt(countSpan.textContent);
        countSpan.textContent = button.classList.contains('plus') ? count + 1 : count - 1;
        updateButtonStates();
    });
    confirmPassengerBtn.addEventListener('click', () => {
        const adults = passengerModal.querySelector('.passenger-row[data-type="adult"] .count').textContent;
        const children = passengerModal.querySelector('.passenger-row[data-type="child"] .count').textContent;
        const infants = passengerModal.querySelector('.passenger-row[data-type="infant"] .count').textContent;
        const cls = passengerModal.querySelector('input[name="travelClassModal"]:checked').value;
        const clsText = passengerModal.querySelector('input[name="travelClassModal"]:checked').parentElement.textContent.trim();
        document.getElementById('adultsInput').value = adults;
        document.getElementById('childrenInput').value = children;
        document.getElementById('infantsInput').value = infants;
        document.getElementById('travelClassInput').value = cls;
        passengerBtn.textContent = `ì„±ì¸ ${adults} ì–´ë¦°ì´ ${children} ìœ ì•„ ${infants} Â· ${clsText}`;
        closePassengerModal();
    });
    updateButtonStates();

    const researchForm = document.querySelector('#researchModal .flight-search-form');
    researchForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const loadingModal = document.getElementById('loadingModal');
        loadingModal.querySelector('p').textContent = 'í•­ê³µê¶Œì„ ì¬ê²€ìƒ‰ì¤‘ì…ë‹ˆë‹¤...';
        loadingModal.style.display = 'flex';
        setTimeout(() => event.target.submit(), 100);
    });

    // --- 6. í•„í„° ë¡œì§ (ì¤‘ë³µ ë°©ì§€ ì ìš©) ---
    function initFilters() {
        const durSliderEl = document.getElementById('duration-slider');
        const priceSliderEl = document.getElementById('price-slider');
        const airlineListContainer = document.getElementById('airline-filter-list');

        if (!durSliderEl || !priceSliderEl || !airlineListContainer) return;

        // ğŸŸ¢ [ìˆ˜ì • 1] ê¸°ì¡´ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
        if (durSliderEl.noUiSlider) {
            durSliderEl.noUiSlider.destroy();
        }
        if (priceSliderEl.noUiSlider) {
            priceSliderEl.noUiSlider.destroy();
        }
        
        // ğŸŸ¢ [ìˆ˜ì • 2] í•­ê³µì‚¬ ëª©ë¡ ì´ˆê¸°í™”
        airlineListContainer.innerHTML = '';

        function parseTime(timeStr) {
            if (!timeStr || !timeStr.includes(':')) return 0; 
            const [hours, minutes] = timeStr.split(':').map(Number);
            return (hours * 60) + minutes;
        }
        function calculateDuration(depTime, arrTime) {
            const depMinutes = parseTime(depTime);
            const arrMinutes = parseTime(arrTime);
            if (arrMinutes >= depMinutes) return arrMinutes - depMinutes;
            else return (1440 - depMinutes) + arrMinutes; 
        }
        function formatDuration(minutes) {
            const m = Math.round(minutes); 
            const h = Math.floor(m / 60);
            const min = m % 60;
            return `${h}ì‹œê°„ ${min}ë¶„`;
        }
        const priceFormatter = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW', minimumFractionDigits: 0 });
        const airlineNames = { '7C': 'ì œì£¼í•­ê³µ', 'LJ': 'ì§„ì—ì–´', 'TW': 'í‹°ì›¨ì´í•­ê³µ', 'KE': 'ëŒ€í•œí•­ê³µ', 'OZ': 'ì•„ì‹œì•„ë‚˜í•­ê³µ', 'RS': 'ì—ì–´ì„œìš¸', 'BX': 'ì—ì–´ë¶€ì‚°', 'ZE': 'ì´ìŠ¤íƒ€í•­ê³µ', 'VJ': 'ë¹„ì—£ì ¯í•­ê³µ', 'VN': 'ë² íŠ¸ë‚¨í•­ê³µ', 'PR': 'í•„ë¦¬í•€í•­ê³µ', 'JL': 'ì¼ë³¸í•­ê³µ', 'NH': 'ì „ì¼ë³¸ê³µìˆ˜', 'MM': 'í”¼ì¹˜í•­ê³µ', 'VZ': 'íƒ€ì´ ë¹„ì—£ì ¯ í•­ê³µ', 'TC': 'íƒ€ì´ ì—ì–´ì•„ì‹œì•„ ì—‘ìŠ¤', 'MU': 'ì¤‘êµ­ë™ë°©í•­ê³µ', 'CZ': 'ì¤‘êµ­ë‚¨ë°©í•­ê³µ', 'YP': 'ì—ì–´í”„ë ˆë¯¸ì•„' };
        
        function getAirlineName(code) { return airlineNames[code] || code; }

        const flightCards = document.querySelectorAll('.flight-item-container');
        if (flightCards.length === 0) {
            // ë°ì´í„° ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë¦¬í„´ (í•„í„° ì•ˆ ë§Œë“¦)
            return; 
        }

        let minPrice = Infinity, maxPrice = 0, minDuration = Infinity, maxDuration = 0;
        const uniqueAirlines = new Set();

        flightCards.forEach(card => {
            const button = card.querySelector('.flight-card-button');
            if (!button) return; 
            const depTime = button.dataset.departureTime;
            const arrTime = button.dataset.arrivalTime;
            const price = parseFloat(button.dataset.totalPrice);
            const carrier = button.dataset.carrierCode;
            
            card.dataset.carrierCode = carrier;
            const depMinutes = parseTime(depTime);
            const duration = calculateDuration(depTime, arrTime);
            
            card.dataset.priceNum = price;
            card.dataset.depMinutes = depMinutes;
            card.dataset.durationMinutes = duration;

            if (!isNaN(price)) { 
                if (price < minPrice) minPrice = price; 
                if (price > maxPrice) maxPrice = price; 
            }
            if (!isNaN(duration)) { 
                if (duration < minDuration) minDuration = duration; 
                if (duration > maxDuration) maxDuration = duration; 
            }
            uniqueAirlines.add(carrier);
        });
        
        if (minPrice === Infinity) minPrice = 0;
        if (minDuration === Infinity) minDuration = 0;
        if (maxPrice === 0) maxPrice = minPrice + 10000;
        if (maxDuration === 0) maxDuration = minDuration + 60; 
        
        if (minPrice === maxPrice) { minPrice -= 1; maxPrice += 1; }
        if (minDuration === maxDuration) { minDuration -= 1; maxDuration += 1; }

        uniqueAirlines.forEach(code => {
            const airlineName = getAirlineName(code);
            const itemId = `airline-${code}`;
            const itemHtml = `<span class="airline-filter-item"><input class="form-check-input" type="checkbox" value="${code}" id="${itemId}"><label class="form-check-label" for="${itemId}">${airlineName} (${code})</label></span>`;
            airlineListContainer.insertAdjacentHTML('beforeend', itemHtml);
        });

        noUiSlider.create(durSliderEl, { range: { 'min': minDuration, 'max': maxDuration }, start: [minDuration, maxDuration], connect: true, step: 10, tooltips: [ { to: formatDuration, from: Number }, { to: formatDuration, from: Number } ], format: { to: v => Math.round(v), from: v => Math.round(v) } });
        noUiSlider.create(priceSliderEl, { range: { 'min': minPrice, 'max': maxPrice }, start: [minPrice, maxPrice], connect: true, step: 1000, tooltips: [ { to: v => priceFormatter.format(v), from: Number }, { to: v => priceFormatter.format(v), from: Number } ], format: { to: v => Math.round(v), from: v => Math.round(v) } });

        const durMinLabel = document.getElementById('duration-min');
        const durMaxLabel = document.getElementById('duration-max');
        const priceMinLabel = document.getElementById('price-min');
        const priceMaxLabel = document.getElementById('price-max');
        
        function updateFilters() {
            const checkedTimeBtns = document.querySelectorAll('input[name="timeFilter"]:checked');
            const timeRanges = Array.from(checkedTimeBtns).map(btn => ({ min: parseInt(btn.dataset.min), max: parseInt(btn.dataset.max) }));
            
            if(!durSliderEl.noUiSlider || !priceSliderEl.noUiSlider) return;

            const [durMin, durMax] = durSliderEl.noUiSlider.get().map(Number);
            const [priceMin, priceMax] = priceSliderEl.noUiSlider.get().map(Number);
            const checkedAirlines = Array.from(document.querySelectorAll('#airline-filter-list input[type="checkbox"]:checked')).map(cb => cb.value);

            flightCards.forEach(card => {
                const depMinutes = parseInt(card.dataset.depMinutes);
                const duration = parseInt(card.dataset.durationMinutes);
                const price = parseInt(card.dataset.priceNum);
                const carrier = card.dataset.carrierCode;

                const showByDep = timeRanges.some(range => (depMinutes >= range.min && depMinutes <= range.max));
                const showByDur = (duration >= durMin && duration <= durMax);
                const showByPrice = (price >= priceMin && price <= priceMax);
                const showByAirline = (checkedAirlines.length === 0) || checkedAirlines.includes(carrier);

                card.style.display = (showByDep && showByDur && showByPrice && showByAirline) ? 'block' : 'none';
            });
        }

        durSliderEl.noUiSlider.on('update', (values) => { durMinLabel.textContent = formatDuration(values[0]); durMaxLabel.textContent = formatDuration(values[1]); updateFilters(); });
        priceSliderEl.noUiSlider.on('update', (values) => { priceMinLabel.textContent = priceFormatter.format(values[0]); priceMaxLabel.textContent = priceFormatter.format(values[1]); updateFilters(); });
        
        const timeAllBtn = document.getElementById('time-all');
        const timeOptionBtns = document.querySelectorAll('.time-filter-option');
        
        // Clone Hackìœ¼ë¡œ ì¤‘ë³µ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
        const oldTimeAllBtn = document.getElementById('time-all');
        const newTimeAllBtn = oldTimeAllBtn.cloneNode(true);
        oldTimeAllBtn.parentNode.replaceChild(newTimeAllBtn, oldTimeAllBtn);
        
        const refreshedTimeAllBtn = document.getElementById('time-all');
        refreshedTimeAllBtn.addEventListener('change', function() {
            if (this.checked) timeOptionBtns.forEach(btn => btn.checked = false);
            else if (!Array.from(timeOptionBtns).some(btn => btn.checked)) this.checked = true;
            updateFilters();
        });

        timeOptionBtns.forEach(btn => {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.addEventListener('change', function() {
                if (this.checked) refreshedTimeAllBtn.checked = false;
                else if (!Array.from(document.querySelectorAll('.time-filter-option')).some(b => b.checked)) refreshedTimeAllBtn.checked = true;
                updateFilters();
            });
        });

        document.querySelectorAll('#airline-filter-list input[type="checkbox"]').forEach(checkbox => checkbox.addEventListener('change', updateFilters));
        
        durMinLabel.textContent = formatDuration(minDuration);
        durMaxLabel.textContent = formatDuration(maxDuration);
        priceMinLabel.textContent = priceFormatter.format(minPrice);
        priceMaxLabel.textContent = priceFormatter.format(maxPrice);
        
        updateFilters();
    }
</script>
</body>
</html>