<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>ë¬´ì„±ì˜ ì±„íŒ… - ìŠ¤í¬ë¡¤ í•´ì œ ëª¨ë“œ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- í°íŠ¸: Noto Sans KR -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="css/animate.css">
<link rel="stylesheet" href="css/icomoon.css">
<link rel="stylesheet" href="css/bootstrap.css">
<link rel="stylesheet" href="css/style.css">

<script src="js/modernizr-2.6.2.min.js"></script>

<style type="text/css">
    /* === ê¸°ë³¸ ì„¤ì • === */
    html {
        scroll-behavior: smooth; /* ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
    }
    body {
        font-family: 'Noto Sans KR', 'Open Sans', sans-serif;
        background-color: #f0f2f5;
        color: #333;
    }

    /* === í—¤ë” (ìœ ì§€) === */
    .moana_gnb {
        background-color: #5ac4c9;
        color: #fff;
        padding: 10px 0;
        position: sticky; /* í—¤ë” ìƒë‹¨ ê³ ì • */
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .gnb_container {
        max-width: 1600px;
        width: 95%;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
    }
    .moana_gnb h1 { margin: 0; display: flex; align-items: center; }
    .box__inner h1 a { color: #fff; text-decoration: none; font-size: 22px; font-weight: bold; }
    .list__tab { list-style: none; margin: 0; padding: 0; display: flex; gap: 20px; }
    .list__tab .list-item a { color: #fff; text-decoration: none; font-weight: bold; padding: 5px 0; position: relative; transition: color 0.3s ease; }
    .list__tab .list-item a:hover, .list__tab .list-item a.link__tab--active { color: #eee; }
    .list__tab .list-item a.link__tab--active::after { content: ''; position: absolute; left: 0; bottom: -5px; width: 100%; height: 2px; background-color: #fff; }
    .link__booking-history { background-color: transparent; border: 1px solid #fff; color: #fff; padding: 8px 15px; border-radius: 20px; text-decoration: none; font-size: 14px; transition: background-color 0.3s ease, color 0.3s ease; }
    .link__booking-history:hover { background-color: #fff; color: #5ac4c9; }
    .navi_opener { display: none; }

    /* === [ë©”ì¸ ë ˆì´ì•„ì›ƒ] ì»¨í…Œì´ë„ˆ === */
    .container {
        max-width: 1400px !important;
        width: 95%;
        margin-top: 30px;
        margin-bottom: 80px; /* í•˜ë‹¨ ì—¬ë°± ì¶©ë¶„íˆ */
        padding: 0;
    }

    /* === [ìˆ˜ì •] í†µí•© ì¸í„°í˜ì´ìŠ¤ ì¹´ë“œ === 
       ë†’ì´ ì œí•œ(height, overflow)ì„ ì œê±°í•˜ì—¬ ë‚´ìš©ë§Œí¼ ëŠ˜ì–´ë‚˜ê²Œ ë³€ê²½ 
    */
    .main-interface-card {
        background: #ffffff;
        border-radius: 20px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
        min-height: 600px; /* ìµœì†Œ ë†’ì´ë§Œ ì§€ì • */
        height: auto; /* ë†’ì´ ìë™ í™•ì¥ */
    }

    /* 1. ì±„íŒ… ì˜ì—­ (ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì œê±°) */
    #chatBox {
        /* flex: 1; ì œê±° - ë¶€ëª¨ ë†’ì´ê°€ autoì´ë¯€ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ íë¦„ */
        background-color: #fff;
        padding: 40px 30px; /* ìƒí•˜ íŒ¨ë”© ë„‰ë„‰í•˜ê²Œ */
        overflow: visible; /* ìŠ¤í¬ë¡¤ë°” ì œê±°, ë‹¤ ë³´ì—¬ì£¼ê¸° */
        min-height: 200px;
    }

    /* ë§í’ì„  ìŠ¤íƒ€ì¼ */
    .msgContent {
        display: inline-block;
        padding: 12px 20px;
        border-radius: 18px;
        max-width: 80%;
        text-align: left;
        font-size: 16px;
        line-height: 1.6;
        position: relative;
    }
    .receiveMsg { text-align: left; margin-bottom: 25px; } /* ë©”ì‹œì§€ ê°„ ê°„ê²© í™•ëŒ€ */
    .receiveMsg .msgContent {
        background-color: #f1f3f5;
        color: #333;
        border-radius: 4px 18px 18px 18px;
    }
    .sendMsg { text-align: end; margin-bottom: 25px; }
    .sendMsg .msgContent {
        background-color: #5ac4c9;
        color: #fff;
        border-radius: 18px 4px 18px 18px;
        font-weight: 500;
    }

    /* 2. ì„ íƒ ì˜µì…˜ ì˜ì—­ (êµ¬ë¶„ì„  ë° ì—¬ë°±) */
    #recommendationFormContainer {
        background-color: #fcfcfc;
        padding: 30px 30px;
        border-top: 2px solid #f1f3f5; /* ì±„íŒ…ê³¼ ëª…í™•í•œ êµ¬ë¶„ì„  */
        border-bottom: 1px solid #eee;
    }

    .selection-label {
        color: #555;
        font-weight: 700;
        font-size: 15px;
        margin-bottom: 10px;
        display: block;
    }

    .selection-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 0;
    }

    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-option {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 20px;
        padding: 8px 16px;
        font-size: 14px;
        color: #555;
        cursor: pointer;
        transition: all 0.2s ease;
        outline: none;
        font-weight: 500;
    }
    .btn-option:hover {
        background-color: #f8f9fa;
        border-color: #ccc;
        color: #333;
    }
    .btn-option.active {
        background-color: #5ac4c9;
        border-color: #5ac4c9;
        color: #fff;
        font-weight: 700;
        box-shadow: 0 2px 5px rgba(90, 196, 201, 0.3);
    }
    
    input[type="date"] {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 6px 12px;
        color: #555;
        font-family: 'Noto Sans KR', sans-serif;
        font-size: 14px;
        width: 100%;
    }

    /* 3. ì…ë ¥ì°½ ì˜ì—­ (í•˜ë‹¨) */
    .input-area-wrapper {
        background-color: #fff;
        padding: 20px 30px 30px 30px; /* í•˜ë‹¨ ì—¬ë°± ì¶”ê°€ */
    }

    #fh5co-subscribe {
        position: relative;
        background: #f8f9fa;
        border-radius: 30px;
        padding: 5px;
        border: 1px solid #e9ecef;
        box-shadow: none;
        display: flex;
        align-items: center;
    }

    #fh5co-subscribe .form-group {
        width: 100%;
        margin-bottom: 0;
        display: flex;
        align-items: center;
    }

    #fh5co-subscribe .form-control {
        width: 100%;
        background-color: transparent;
        border: none;
        color: #333;
        border-radius: 30px;
        padding: 12px 20px;
        box-shadow: none;
        height: auto;
        font-size: 15px;
    }
    
    #fh5co-subscribe .form-control:focus {
        outline: none;
        box-shadow: none;
    }

    #fh5co-subscribe .btn-primary {
        background-color: #5ac4c9;
        border-color: #5ac4c9;
        border-radius: 25px;
        padding: 10px 25px;
        margin-right: 5px;
        font-weight: bold;
        color: #fff;
        border: none;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: background-color 0.3s;
        white-space: nowrap;
        height: auto;
    }

    #fh5co-subscribe .btn-primary:hover {
        background-color: #4aa0a5;
    }

    #newSearchContainer {
        padding: 15px 30px;
        background-color: #fff;
        border-top: 1px solid #eee;
        text-align: center;
    }
    #newSearchContainer .btn-new-search {
        background-color: #6c757d; color: #fff; border: none;
        border-radius: 25px; padding: 10px 20px;
        font-weight: bold; cursor: pointer; transition: 0.3s;
        font-size: 14px;
    }
    #newSearchContainer .btn-new-search:hover { background-color: #5a6268; }

    /* ì¶”ì²œ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .recommendation-container {
        display: flex; flex-direction: row; flex-wrap: wrap; gap: 20px; margin-top: 20px; width: 100%;
    }
    .recommendation-card {
        background-color: #fff; 
        border: 1px solid #eee; 
        border-radius: 20px;
        padding: 30px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        flex: 1 1 300px; 
        min-width: 300px; 
        position: relative; 
        overflow: hidden;
    }
    .recommendation-card::before {
        content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 8px; background-color: #5ac4c9;
    }
    .rec-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 20px; 
        border-bottom: 1px solid #f0f0f0; 
        padding-bottom: 15px; 
    }
    .rec-city { font-size: 20px; font-weight: 700; color: #222; }
    .rec-country { 
        font-size: 14px; 
        color: #5ac4c9; 
        background: rgba(90, 196, 201, 0.1); 
        padding: 5px 12px; 
        border-radius: 15px; 
    }
    
    .rec-body p {
        font-size: 16px;
        color: #555;
        line-height: 1.8; 
        margin-bottom: 20px; 
        word-break: keep-all; 
    }

    .rec-activities {
        background-color: #f9fbfb;
        padding: 20px; 
        border-radius: 15px;
        margin-bottom: 20px;
    }
    .rec-activities strong {
        display: block;
        margin-bottom: 12px;
        font-size: 16px;
        color: #333;
    }
    .rec-activities ul {
        margin: 0;
        padding-left: 20px;
    }
    .rec-activities li {
        font-size: 15px;
        color: #666;
        margin-bottom: 8px; 
        line-height: 1.6;
    }

    .btn-flight-search {
        display: block; 
        width: 100%; 
        margin-top: 25px; 
        padding: 15px;
        background-color: #5ac4c9; 
        color: #fff; 
        border: none; 
        border-radius: 12px;
        font-weight: bold; 
        cursor: pointer; 
        font-size: 16px;
        transition: background-color 0.3s;
    }
    .btn-flight-search:hover {
        background-color: #4aa0a5;
        text-decoration: none;
        color: #fff;
    }

    /* ë¡œë”© ëª¨ë‹¬ */
    #flightSearchLoadingModal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.6); z-index: 2000;
        display: none; justify-content: center; align-items: center; flex-direction: column; color: #fff;
        backdrop-filter: blur(4px);
    }
    #flightSearchLoadingModal .spinner-large { 
        width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #5ac4c9;
        border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    .spinner {
        display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(0,0,0,.1); border-radius: 50%;
        border-top-color: #5ac4c9; animation: spin 1s ease-in-out infinite; margin-right: 8px; vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
    <div id="flightSearchLoadingModal">
        <div class="spinner-large"></div>
        <p>í•­ê³µê¶Œ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div class="moana_gnb" role="complementary">
        <div class="gnb_container">
            <div class="box__inner">
                <h1><a href="/">ë¬´ì„±ì˜ ì—¬í–‰</a></h1>
            </div>
            <ul class="list__tab">
                <li class="list-item"><a class="link__tab" href="/">í•­ê³µ</a></li>
                <li class="list-item"><a class="link__tab link__tab--active" href="/chat">ì¶”ì²œì±—</a></li>
            </ul>
            <div class="link-container">
                <a href="/revList" class="link__booking-history sp_sd--after" th:if="${session.loginUser != null}">ë‚˜ì˜ ì˜ˆì•½ë‚´ì—­</a> 
                <a th:if="${session.loginUser == null}" class="link__booking-history sp_sd--after" href="/member/login">ë¡œê·¸ì¸</a>
                <a th:if="${session.loginUser != null}" th:text="${session.loginUser.UserName}" class="link__booking-history sp_sd--after">ì‚¬ìš©ì</a> 
                <a th:if="${session.loginUser != null}" class="link__booking-history sp_sd--after" href="/member/logout">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="main-interface-card">
            
            <!-- 1. ì±„íŒ…ì°½ (ë†’ì´ ë¬´ì œí•œ) -->
            <div id="chatBox"></div>

            <!-- 2. ì„ íƒ UI -->
            <div id="recommendationFormContainer">
                <input type="hidden" id="selectDeparture" value="ICN">
                <input type="hidden" id="selectRegion" value="any">
                <input type="hidden" id="selectTheme" value="any">
                <input type="hidden" id="selectDuration" value="any">
                <input type="hidden" id="selectBudget" value="any">

                <div class="row" style="margin-bottom: 15px;">
                    <div class="col-md-6 col-12 mb-3 mb-md-0">
                        <label class="selection-label">ğŸ›« ì–´ë””ì„œ ì¶œë°œí•˜ì‹œë‚˜ìš”?</label>
                        <div class="selection-group" id="groupDeparture">
                            <button type="button" class="btn-option active" data-value="ICN">ì¸ì²œ</button>
                            <button type="button" class="btn-option" data-value="GMP">ê¹€í¬</button>
                            <button type="button" class="btn-option" data-value="PUS">ê¹€í•´</button>
                            <button type="button" class="btn-option" data-value="CJU">ì œì£¼</button>
                            <button type="button" class="btn-option" data-value="TAE">ëŒ€êµ¬</button>
                            <button type="button" class="btn-option" data-value="RSU">ì—¬ìˆ˜</button>
                        </div>
                    </div>
                    <div class="col-md-6 col-12">
                        <label class="selection-label" for="inputDateUI">ğŸ“… ì–¸ì œ ë– ë‚˜ì‹œë‚˜ìš”?</label>
                        <input type="date" id="inputDateUI">
                    </div>
                </div>

                <div class="row" style="margin-bottom: 15px;">
                    <div class="col-md-6 col-12 mb-3 mb-md-0">
                        <label class="selection-label">ğŸŒ ì–´ë””ë¡œ ê°€ê³  ì‹¶ìœ¼ì„¸ìš”?</label>
                        <div class="selection-group" id="groupRegion">
                            <button type="button" class="btn-option active" data-value="any">ì–´ë””ë“  ì¢‹ì•„ìš”</button>
                            <button type="button" class="btn-option" data-value="asia">ì•„ì‹œì•„</button>
                            <button type="button" class="btn-option" data-value="europe">ìœ ëŸ½</button>
                            <button type="button" class="btn-option" data-value="america">ë¯¸ì£¼</button>
                            <button type="button" class="btn-option" data-value="oceania">ì˜¤ì„¸ì•„ë‹ˆì•„</button>
                            <button type="button" class="btn-option" data-value="korea">êµ­ë‚´</button>
                        </div>
                    </div>
                    <div class="col-md-6 col-12">
                        <label class="selection-label">ğŸ¡ ì–´ë–¤ ì—¬í–‰ì„ ì›í•˜ì„¸ìš”?</label>
                        <div class="selection-group" id="groupTheme">
                            <button type="button" class="btn-option active" data-value="any">ìƒê´€ì—†ì–´ìš”</button>
                            <button type="button" class="btn-option" data-value="healing">ğŸ íœ´ì–‘/íë§</button>
                            <button type="button" class="btn-option" data-value="food">ğŸœ ë¯¸ì‹</button>
                            <button type="button" class="btn-option" data-value="tour">ğŸ° ê´€ê´‘</button>
                            <button type="button" class="btn-option" data-value="activity">ğŸ„ ì•¡í‹°ë¹„í‹°</button>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 col-12 mb-3 mb-md-0">
                        <label class="selection-label">ğŸŒ™ ì—¬í–‰ ê¸°ê°„ì€?</label>
                        <div class="selection-group" id="groupDuration">
                            <button type="button" class="btn-option active" data-value="any">ìƒê´€ì—†ì–´ìš”</button>
                            <button type="button" class="btn-option" data-value="1-2">1ë°• 2ì¼</button>
                            <button type="button" class="btn-option" data-value="2-3">2ë°• 3ì¼</button>
                            <button type="button" class="btn-option" data-value="3-4">3ë°• 4ì¼</button>
                            <button type="button" class="btn-option" data-value="4-5">4ë°• 5ì¼</button>
                            <button type="button" class="btn-option" data-value="long">6ì¼ ì´ìƒ</button>
                        </div>
                    </div>
                    <div class="col-md-6 col-12">
                        <label class="selection-label">ğŸ’° 1ì¸ë‹¹ ì˜ˆì‚°ì€?</label>
                        <div class="selection-group" id="groupBudget">
                            <button type="button" class="btn-option active" data-value="any">ìƒê´€ì—†ì–´ìš”</button>
                            <button type="button" class="btn-option" data-value="low">50ë§Œì› â†“</button>
                            <button type="button" class="btn-option" data-value="medium">50~100ë§Œ</button>
                            <button type="button" class="btn-option" data-value="high">100~200ë§Œ</button>
                            <button type="button" class="btn-option" data-value="luxury">200ë§Œì› â†‘</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="newSearchContainer" style="display: none;">
                <button id="btnNewSearch" class="btn-new-search">ğŸ”„ ìƒˆë¡œìš´ ì—¬í–‰ ì¶”ì²œë°›ê¸°</button>
            </div>

            <!-- 3. ì…ë ¥ì°½ (í•˜ë‹¨) -->
            <div class="input-area-wrapper">
                <form id="fh5co-subscribe">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="ì¶”ê°€ ìš”ì²­ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì¡°ìš©í•œ ê³³ì´ ì¢‹ì•„)"> 
                        <button type="submit" class="btn btn-primary" id="btnSendChat">
                             ì „ì†¡ âœˆï¸
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="js/jquery.min.js"></script>
    <script src="js/jquery.easing.1.3.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.waypoints.min.js"></script>
    <script src="js/simplyCountdown.js"></script>
    <script src="js/main.js"></script>
    <script type="text/javascript" src="/webjars/sockjs-client/1.5.1/sockjs.js"></script>
    <script type="text/javascript" src="/webjars/stomp-websocket/2.3.4/stomp.js"></script>

    <script>
    let stompClient = null;
    const chatBox = document.getElementById('chatBox');
    const messageInput = document.querySelector('#fh5co-subscribe .form-control');
    const sendButton = document.getElementById('btnSendChat'); 
    const newSearchButton = document.getElementById('btnNewSearch'); 
    
    let localConversationHistory = [];
    const flightSearchLoadingModal = document.getElementById('flightSearchLoadingModal');
    
    let chatMode = 'recommend'; 

    const departurePermissions = {
        'ICN': ['any', 'asia', 'europe', 'america', 'oceania', 'korea'],
        'GMP': ['asia', 'korea'],
        'PUS': ['asia', 'korea'],
        'CJU': ['asia', 'korea'],
        'TAE': ['korea'],
        'RSU': ['korea']
    };

    function setupOptionButtons() {
        const groups = [
            { groupId: 'groupDeparture', inputId: 'selectDeparture', callback: updateRegionOptions }, 
            { groupId: 'groupRegion', inputId: 'selectRegion' },
            { groupId: 'groupTheme', inputId: 'selectTheme' },
            { groupId: 'groupDuration', inputId: 'selectDuration' },
            { groupId: 'groupBudget', inputId: 'selectBudget' }
        ];

        groups.forEach(group => {
            const container = document.getElementById(group.groupId);
            if(!container) return;
            const buttons = container.querySelectorAll('.btn-option');
            buttons.forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.disabled || this.classList.contains('disabled')) return;
                    buttons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(group.inputId).value = this.getAttribute('data-value');
                    if (group.callback) group.callback();
                });
            });
        });
    }

    function updateRegionOptions() {
        const departureValue = document.getElementById('selectDeparture').value;
        const regionContainer = document.getElementById('groupRegion');
        const regionButtons = regionContainer.querySelectorAll('.btn-option');
        const allowedRegions = departurePermissions[departureValue] || [];
        let isCurrentSelectionInvalid = false;

        regionButtons.forEach(btn => {
            const regionCode = btn.getAttribute('data-value');
            if (allowedRegions.includes(regionCode)) {
                btn.disabled = false;
                btn.classList.remove('disabled');
            } else {
                btn.disabled = true;
                btn.classList.add('disabled');
                if (btn.classList.contains('active')) {
                    isCurrentSelectionInvalid = true;
                    btn.classList.remove('active');
                }
            }
        });

        if (isCurrentSelectionInvalid) {
            const firstValidBtn = Array.from(regionButtons).find(b => !b.disabled);
            if (firstValidBtn) {
                firstValidBtn.classList.add('active');
                document.getElementById('selectRegion').value = firstValidBtn.getAttribute('data-value');
            }
        }
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        const dateInput = document.getElementById('inputDateUI');
        if (dateInput) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;
            dateInput.value = todayString;
            dateInput.setAttribute('min', todayString);
        }

        loadChatHistory(); 
        setupOptionButtons();
        updateRegionOptions(); 
    });

    sendButton.addEventListener('click', sendMessage, true);
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage(e);
        }
    });
    newSearchButton.addEventListener('click', function() {
        setChatMode('recommend');
    });

    async function loadChatHistory() {
        try {
            const response = await fetch('/chat/history');
            if (!response.ok) throw new Error('History fetch failed');
            const history = await response.json();
            localConversationHistory = history;
            history.forEach(message => {
                if (message.sender.toLowerCase() === 'ai') {
                    try {
                        const aiData = JSON.parse(message.content);
                        displayMessage(message.sender, aiData);
                    } catch (e) {
                        displayMessage(message.sender, { chat_response: message.content });
                    }
                }
            });
        } catch (error) {
            console.error('Error loading chat history:', error);
        } finally {
            connect();
        }
    }

    function connect() {
        const socket = new SockJS('/ws-chatin');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            stompClient.subscribe('/user/queue/reply', function(message) {
                removeLoadingIndicator();
                const chatMessagePayload = JSON.parse(message.body);
                const aiRawJson = chatMessagePayload.content;
                try {
                    const aiData = JSON.parse(aiRawJson);
                    displayMessage("AI", aiData); 
                    localConversationHistory.push({
                        sender: "AI",
                        content: aiRawJson
                    });
                } catch (e) {
                    console.error("JSON Parsing Error:", e);
                    const errorData = { chat_response: aiRawJson }; 
                    displayMessage("AI", errorData);
                }
            });
        });
    }

    function sendMessage(event) {
        event.preventDefault();
        const userText = messageInput.value.trim();
        let llmPrompt; 
        let userDisplayMessage; 
        let messageType = chatMode; 

        if (chatMode === 'recommend') {
            const departureDate = document.getElementById('inputDateUI').value;
            const getActiveText = (groupId) => {
                const activeBtn = document.querySelector(`#${groupId} .btn-option.active`);
                return activeBtn ? activeBtn.textContent : "ì„ íƒ ì•ˆí•¨";
            };
            
            if (!departureDate) {
                alert('ì¶œë°œ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const departure = getActiveText('groupDeparture');
            const region = getActiveText('groupRegion');
            const theme = getActiveText('groupTheme');
            const duration = getActiveText('groupDuration');
            const budget = getActiveText('groupBudget');

            llmPrompt = `[ì„ íƒ ì¡°ê±´] - ì¶œë°œì§€: ${departure}, ì¶œë°œ ë‚ ì§œ: ${departureDate}, ì§€ì—­: ${region}, í…Œë§ˆ: ${theme}, ê¸°ê°„: ${duration}, ê²½ë¹„: ${budget} \n[ì‚¬ìš©ì ì¶”ê°€ ìš”ì²­] - ${userText}`;
            userDisplayMessage = userText || "ì—¬í–‰ì§€ ì¶”ì²œí•´ì¤˜"; 
        } else {
            if (!userText) {
                alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            llmPrompt = userText;
            userDisplayMessage = userText;
        }

        if (stompClient) {
            displayMessage("user", userDisplayMessage);
            displayLoadingIndicator(); 

            localConversationHistory.push({ sender: "user", content: llmPrompt });
            const payload = { type: messageType, content: llmPrompt, history: localConversationHistory };
            stompClient.send("/app/sendMessage", {}, JSON.stringify(payload));
            messageInput.value = '';
        }
    }

    function displayMessage(sender, content) {
        const messageElement = document.createElement('div');
        let messageHTML = '';

        if (sender.toLowerCase() === 'ai') {
            messageElement.classList.add('receiveMsg');

            let aiData = content;
            if (typeof content === 'string') {
                try { aiData = JSON.parse(content); } catch (e) { aiData = { chat_response: content }; }
            }

            let htmlContent = '';
            if (aiData.chat_response) {
                htmlContent += `<div>${aiData.chat_response.replace(/\n/g, '<br>')}</div>`;
            }

            if (aiData.recommendations && Array.isArray(aiData.recommendations) && aiData.recommendations.length > 0) {
                htmlContent += `<div class="recommendation-container">`;
                aiData.recommendations.forEach((rec, index) => {
                    htmlContent += `
                        <div class="recommendation-card">
                            <div class="rec-header">
                                <span class="rec-city">${index + 1}. ${rec.city}</span>
                                <span class="rec-country">${rec.country}</span>
                            </div>
                            <div class="rec-body">
                                <p><b>ğŸ’¡ ì¶”ì²œ ì´ìœ :</b> ${rec.reason}</p>
                            </div>
                            ${rec.activities && rec.activities.length > 0 ? `
                                <div class="rec-activities">
                                    <strong>âœ¨ ì¦ê¸¸ê±°ë¦¬:</strong>
                                    <ul>
                                        ${rec.activities.map(act => `<li>${act}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${rec.iataCode && rec.iataCode !== "N/A" ? `
                                <button class="btn-flight-search" 
                                        onclick="searchFlights('${rec.iataCode}', '${rec.city}')">
                                    âœˆï¸ ${rec.city} í•­ê³µê¶Œ ì¡°íšŒ
                                </button>
                            ` : ''}
                        </div>
                    `;
                });
                htmlContent += `</div>`;
                setChatMode('follow-up'); 
            }

            messageHTML = `<div><div class="msgContent">${htmlContent}</div></div>`;

        } else { 
            messageElement.classList.add('sendMsg');
            const userContent = content || "(ë‚´ìš© ì—†ìŒ)";
            messageHTML = `<div><div class="msgContent">${userContent.replace(/\n/g, '<br>')}</div></div>`;
        }

        messageElement.innerHTML = messageHTML;
        chatBox.appendChild(messageElement);
        
        // [ìˆ˜ì •] í™”ë©´ ì „ì²´ë¥¼ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤ (ì±„íŒ…ì°½ ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì•„ë‹˜)
        window.scrollTo(0, document.body.scrollHeight);
    }

    function setChatMode(mode) {
        const recommendContainer = document.getElementById('recommendationFormContainer');
        const newSearchContainer = document.getElementById('newSearchContainer');
        
        chatMode = mode;
        if (mode === 'follow-up') {
            if(recommendContainer) recommendContainer.style.display = 'none';
            if(newSearchContainer) newSearchContainer.style.display = 'block';
            messageInput.placeholder = 'ì¶”ì²œ ì—¬í–‰ì§€ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”...';
        } else { 
            if(recommendContainer) recommendContainer.style.display = 'block';
            if(newSearchContainer) newSearchContainer.style.display = 'none';
            messageInput.placeholder = 'ì¶”ê°€ ìš”ì²­ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”';
        }
    }

    function displayLoadingIndicator() {
        removeLoadingIndicator();
        const messageElement = document.createElement('div');
        messageElement.classList.add('receiveMsg');
        messageElement.id = 'loadingIndicator';
        messageElement.innerHTML = `<div><div class="msgContent" style="background:#f8f9fa;"> <div class="spinner"></div> ì—¬í–‰ì§€ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</div></div>`;
        chatBox.appendChild(messageElement);
        // [ìˆ˜ì •] ë¡œë”© ì‹œì—ë„ í™”ë©´ ì•„ë˜ë¡œ
        window.scrollTo(0, document.body.scrollHeight);
    }

    function removeLoadingIndicator() {
        const loader = document.getElementById('loadingIndicator');
        if (loader) loader.remove();
    }

    function searchFlights(arrivalCode, arrivalCityName) {
        if (flightSearchLoadingModal) flightSearchLoadingModal.style.display = 'flex';
        
        const departureSelect = document.getElementById('selectDeparture');
        const departureDate = document.getElementById('inputDateUI').value; 
        const durationText = document.querySelector('#groupDuration .btn-option.active').textContent;
        const departureCode = departureSelect.value;
        const departureKoLocation = document.querySelector('#groupDeparture .btn-option.active').textContent;

        let returnDate = "";
        let tripType = "one-way";

        if (durationText !== "ìƒê´€ì—†ì–´ìš”" && durationText !== "any") {
            const nights = parseInt(durationText.match(/\d+/)?.[0]);
            if (!isNaN(nights)) {
                const date = new Date(departureDate);
                date.setDate(date.getDate() + nights);
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                returnDate = `${year}-${month}-${day}`;
                tripType = "round-trip";
            }
        }

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/air/searchAirport';

        const params = {
            departureCode, arrivalCode, departureDate, returnDate, tripType,
            adults: "1", children: "0", infants: "0", travelClass: "ECONOMY",
            directFlight: "false", departureKoLocation, arrivalKoLocation: arrivalCityName
        };

        for (const key in params) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = params[key];
            form.appendChild(input);
        }

        document.body.appendChild(form);
        form.submit();
    }

    window.onbeforeunload = function() {
        if (stompClient !== null) stompClient.disconnect();
    };
</script>
</body>
</html>