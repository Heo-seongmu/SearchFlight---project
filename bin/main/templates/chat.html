<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Launcher &mdash; Free Website Template, Free HTML5
	Template by FreeHTML5.co</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description"
	content="Free HTML5 Website Template by FreeHTML5.co" />
<meta name="keywords"
	content="free website templates, free html5, free template, free bootstrap, free website template, html5, css3, mobile first, responsive" />
<meta name="author" content="FreeHTML5.co" />

<link
	href="[https://fonts.googleapis.com/css?family=Open+Sans:400,700,800](https://fonts.googleapis.com/css?family=Open+Sans:400,700,800)"
	rel="stylesheet">

<link rel="stylesheet" href="css/animate.css">
<link rel="stylesheet" href="css/icomoon.css">
<link rel="stylesheet" href="css/bootstrap.css">
<link rel="stylesheet" href="css/style.css">

<script src="js/modernizr-2.6.2.min.js"></script>

<style type="text/css">
/* ... (ê¸°ì¡´ ìŠ¤íƒ€ì¼: .moana_gnb, .gnb_container, .list__tab ë“±) ... */
.moana_gnb {
	background-color: #5ac4c9;
	color: #fff;
	padding: 10px 0;
}

.gnb_container {
	max-width: 1200px;
	margin: 0 auto;
	display: flex;
	align-items: center;
	justify-content: space-between;
	padding: 0 20px;
}

.moana_gnb h1 {
	margin: 0;
	display: flex;
	align-items: center;
}

.moana_gnb h1 img {
	height: 32px;
	vertical-align: middle;
}

.list__tab {
	list-style: none;
	margin: 0;
	padding: 0;
	display: flex;
	gap: 20px;
}

.list__tab .list-item a {
	color: #fff;
	text-decoration: none;
	font-weight: bold;
	padding: 5px 0;
	position: relative;
	transition: color 0.3s ease;
}

.list__tab .list-item a:hover, .list__tab .list-item a.link__tab--active
	{
	color: #eee;
}

.list__tab .list-item a.link__tab--active::after {
	content: '';
	position: absolute;
	left: 0;
	bottom: -5px;
	width: 100%;
	height: 2px;
	background-color: #fff;
}

.link__booking-history {
	background-color: transparent;
	border: 1px solid #fff;
	color: #fff;
	padding: 8px 15px;
	border-radius: 20px;
	text-decoration: none;
	font-size: 14px;
	transition: background-color 0.3s ease, color 0.3s ease;
}

.link__booking-history:hover {
	background-color: #fff;
	color: #5ac4c9;
}

.navi_opener {
	display: none;
}

.main-content {
	display: flex;
	justify-content: center;
	align-items: center;
	min-height: 130vh;
	padding: 20px;
}
/* ... (ê¸°ì¡´ ì±„íŒ…ì°½ ìŠ¤íƒ€ì¼: #chatBox, .receiveMsg, .sendMsg ë“±) ... */
#chatBox {
	height: 700px;
	background-color: #f0f2f5;
	border: 1px solid #e0e0e0;
	padding: 20px;
	overflow-y: auto;
	border-radius: 12px;
	margin-bottom: 20px;
}

.receiveMsg .msgContent {
	background-color: #ffffff;
	color: #333;
	border: 1px solid #e9ecef;
}

.sendMsg .msgContent {
	background-color: #fef01b;
	color: #333;
}

.sendMsg {
	text-align: end;
	margin-bottom: 7px;
}

.receiveMsg {
	text-align: left;
	margin-bottom: 7px;
}

.msgContent {
	display: inline-block;
	padding: 10px 15px;
	border-radius: 12px;
	max-width: 70%;
	text-align: left;
}

#fh5co-subscribe .form-group {
	margin-bottom: 0;
	display: flex;
}

#fh5co-subscribe .form-control {
	width: 100%;
	background-color: #ffffff;
	border: 1px solid #ced4da;
	color: #495057;
	border-radius: 8px 0 0 8px;
}

#fh5co-subscribe .form-control::placeholder {
	color: #6c757d;
}

#fh5co-subscribe .btn-primary {
	background-color: #5ac4c9;
	border-color: #5ac4c9;
	border-radius: 0 8px 8px 0;
}
/* ... (ê¸°ì¡´ ë¡œë”© ìŠ¤í”¼ë„ˆ, í•­ê³µê¶Œ ë²„íŠ¼ ìŠ¤íƒ€ì¼) ... */
.spinner {
	display: inline-block;
	width: 16px;
	height: 16px;
	border: 2px solid rgba(0, 0, 0, .1);
	border-radius: 50%;
	border-top-color: #5ac4c9;
	animation: spin 1s ease-in-out infinite;
	margin-right: 10px;
	vertical-align: middle;
	position: relative;
	top: -1px;
}

.btn-flight-search {
	display: block;
	width: 100%;
	margin-top: 15px;
	padding: 10px 15px;
	background-color: #5ac4c9;
	color: #fff;
	border: none;
	border-radius: 8px;
	text-align: center;
	font-weight: bold;
	cursor: pointer;
	transition: background-color 0.3s ease;
}

.btn-flight-search:hover {
	background-color: #4aa0a5;
	color: #fff;
	text-decoration: none;
}
/* ... (ê¸°ì¡´ ì „ì²´ í™”ë©´ ë¡œë”© ëª¨ë‹¬ ìŠ¤íƒ€ì¼) ... */
#flightSearchLoadingModal {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background-color: rgba(0, 0, 0, 0.6);
	z-index: 2000; 
	display: none;
	justify-content: center;
	align-items: center;
	flex-direction: column; 
	color: white;
}

#flightSearchLoadingModal .spinner-large { 
	width: 50px;
	height: 50px;
	border: 5px solid #f3f3f3;
	border-top: 5px solid #5ac4c9;
	border-radius: 50%;
	animation: spin 1s linear infinite;
	margin-bottom: 20px;
}

#flightSearchLoadingModal p {
	font-size: 18px;
	font-weight: bold;
}

/* ===== [ì‹ ê·œ] ìƒˆë¡œìš´ ì—¬í–‰ ì¶”ì²œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ===== */
#newSearchContainer .btn-new-search {
	display: block;
	width: 100%;
	padding: 10px 15px;
	background-color: #6c757d; /* íšŒìƒ‰ ê³„ì—´ */
	color: #fff;
	border: none;
	border-radius: 8px;
	text-align: center;
	font-weight: bold;
	cursor: pointer;
	transition: background-color 0.3s ease;
}

#newSearchContainer .btn-new-search:hover {
	background-color: #5a6268;
	color: #fff;
	text-decoration: none;
}

/* ìŠ¤í”¼ë„ˆ íšŒì „ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes spin {
	to { transform: rotate(360deg); }
}
</style>
</head>
<body>
	<div id="flightSearchLoadingModal">
		<div class="spinner-large"></div>
		<p>í•­ê³µê¶Œ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘ì…ë‹ˆë‹¤...</p>
	</div>

	<div class="moana_gnb" role="complementary">
		<div class="gnb_container">
			<div class="box__inner">
				<h1>
					<a href="/" title="ê·œì•„ì˜ ì—¬í–‰" data-montelena-acode="200009522"> <img
						src="//pics.gmarket.co.kr/pc/single/kr/vertical/common/logo_g-travel.png"
						height="32" alt="ê·œì•„ì˜ ì—¬í–‰">
					</a>
				</h1>
			</div>
			<ul class="list__tab">
				<li class="list-item"><a class="link__tab" href="/">í•­ê³µ</a></li>
				<li class="list-item"><a class="link__tab link__tab--active"
					href="/chat">ì¶”ì²œì±—</a></li>
			</ul>
			<div class="link-container">
				<a href="/revList"
					class="link__booking-history sp_sd--after" th:if="${session.loginUser != null}">ë‚˜ì˜ ì˜ˆì•½ë‚´ì—­</a> 
				<a th:if="${session.loginUser == null}"
					class="link__booking-history sp_sd--after" href="member/login">ë¡œê·¸ì¸</a>
				<a th:if="${session.loginUser != null}"
					th:text="${session.loginUser.UserName}"
					class="link__booking-history sp_sd--after">í—ˆì„±ë¬´</a> 
				<a  th:if="${session.loginUser != null}"
					class="link__booking-history sp_sd--after" href="member/logout">ë¡œê·¸ì•„ì›ƒ</a>
			</div>
		</div>
	</div>

	<div class="container">
		<div id="chatBox"></div>

		<div id="recommendationFormContainer">
			<div class="row animate-box" style="margin-bottom: 15px;">
				<div class="col-md-6">
					<div class="form-group">
						<label for="selectDeparture" style="color: #5ac4c9;">ì–´ë””ì„œ
							ì¶œë°œí•˜ì‹œë‚˜ìš”?</label> <select id="selectDeparture" class="form-control">
							<optgroup label="í•´ì™¸ ì¶œë°œ (ì£¼ìš” ê³µí•­)">
								<option value="ICN">ì¸ì²œ (ICN)</option>
								<option value="GMP_INT">ê¹€í¬ (GMP - êµ­ì œì„ )</option>
								<option value="PUS_INT">ê¹€í•´ (PUS - êµ­ì œì„ )</option>
							</optgroup>
							<optgroup label="êµ­ë‚´ ì¶œë°œ (ì£¼ìš” ê³µí•­)">
								<option value="GMP_DOM">ê¹€í¬ (GMP - êµ­ë‚´ì„ )</option>
								<option value="CJU">ì œì£¼ (CJU)</option>
								<option value="PUS_DOM">ê¹€í•´ (PUS - êµ­ë‚´ì„ )</option>
								<option value="RSU">ì—¬ìˆ˜ (RSU)</option>
								<option value="TAE">ëŒ€êµ¬ (TAE)</option>
							</optgroup>
						</select>
					</div>
				</div>
				<div class="col-md-6">
					<div class="form-group">
						<label for="selectDate" style="color: #5ac4c9;">ì–¸ì œ ì¶œë°œí•˜ì‹œë‚˜ìš”?</label>
						<input type="date" id="selectDate" class="form-control">
					</div>
				</div>
			</div>
			<div class="row animate-box" style="margin-bottom: 15px;">
				<div class="col-md-6">
					<div class="form-group">
						<label for="selectRegion" style="color: #5ac4c9;">ì–´ëŠ ì§€ì—­ìœ¼ë¡œ
							ê°€ì‹œë‚˜ìš”?</label> <select id="selectRegion" class="form-control">
							<option value="any">ì–´ë””ë“  ì¢‹ì•„ìš”</option>
							<option value="asia">ì•„ì‹œì•„</option>
							<option value="europe">ìœ ëŸ½</option>
							<option value="america">ë¯¸ì£¼</option>
							<option value="oceania">ì˜¤ì„¸ì•„ë‹ˆì•„</option>
							<option value="korea">êµ­ë‚´</option>
						</select>
					</div>
				</div>
				<div class="col-md-6">
					<div class="form-group">
						<label for="selectTheme" style="color: #5ac4c9;">ì–´ë–¤ í…Œë§ˆë¥¼
							ì›í•˜ì„¸ìš”?</label> <select id="selectTheme" class="form-control">
							<option value="any">ìƒê´€ì—†ì–´ìš”</option>
							<option value="healing">íœ´ì–‘ (íë§)</option>
							<option value="food">ë¯¸ì‹</option>
							<option value="tour">ê´€ê´‘ (ëª…ì†Œ)</option>
							<option value="activity">ì•¡í‹°ë¹„í‹°</option>
						</select>
					</div>
				</div>
			</div>
			<div class="row animate-box" style="margin-bottom: 15px;">
				<div class="col-md-6">
					<div class="form-group">
						<label for="selectDuration" style="color: #5ac4c9;">ëª‡ ë°•ìœ¼ë¡œ
							ê°€ì‹œë‚˜ìš”?</label> <select id="selectDuration" class="form-control">
							<option value="any">ìƒê´€ì—†ì–´ìš”</option>
							<option value="1-2">1ë°• 2ì¼</option>
							<option value="2-3">2ë°• 3ì¼</option>
							<option value="3-4">3ë°• 4ì¼</option>
							<option value="4-5">4ë°• 5ì¼</option>
							<option value="long">6ì¼ ì´ìƒ</option>
						</select>
					</div>
				</div>
				<div class="col-md-6">
					<div class="form-group">
						<label for="selectBudget" style="color: #5ac4c9;">ì—¬í–‰ ê²½ë¹„ëŠ”
							ì–¼ë§ˆì¸ê°€ìš”? (1ì¸ ê¸°ì¤€)</label> <select id="selectBudget"
							class="form-control">
							<option value="any">ìƒê´€ì—†ì–´ìš”</option>
							<option value="low">50ë§Œì› ì´í•˜</option>
							<option value="medium">50~100ë§Œì›</option>
							<option value="high">100~200ë§Œì›</option>
							<option value="luxury">200ë§Œì› ì´ìƒ</option>
						</select>
					</div>
				</div>
			</div>
		</div>
		<div class="col-12 animate-box" id="newSearchContainer"
			style="display: none; margin-bottom: 15px;">
			<button id="btnNewSearch" class="btn-new-search">ğŸ”„ ìƒˆë¡œìš´ ì—¬í–‰
				ì¶”ì²œë°›ê¸°</button>
		</div>

		<div class="col-6 animate-box">
			<form id="fh5co-subscribe">
				<div class="form-group">
					<input type="text" class="form-control"
						placeholder="ì¶”ê°€ ìš”ì²­ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"> 
					<input type="submit"
						value="Send" class="btn btn-primary" id="btnSendChat">
				</div>
			</form>
		</div>
	</div>

	<script src="js/jquery.min.js"></script>
	<script src="js/jquery.easing.1.3.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/jquery.waypoints.min.js"></script>
	<script src="js/simplyCountdown.js"></script>
	<script src="js/main.js"></script>
	<script type="text/javascript"
		src="/webjars/sockjs-client/1.5.1/sockjs.js"></script>
	<script type="text/javascript"
		src="/webjars/stomp-websocket/2.3.4/stomp.js"></script>

	<script>
		// --- ìŠ¤í¬ë¦½íŠ¸ ---

		let stompClient = null;
		const chatBox = document.getElementById('chatBox');
		const messageForm = document.getElementById('fh5co-subscribe');
		const messageInput = document.querySelector('#fh5co-subscribe .form-control');
		const sendButton = document.getElementById('btnSendChat'); // [ì‹ ê·œ] ì „ì†¡ ë²„íŠ¼
		const newSearchButton = document.getElementById('btnNewSearch'); // [ì‹ ê·œ] ìƒˆ ì¶”ì²œ ë²„íŠ¼
		
		let localConversationHistory = [];
		const flightSearchLoadingModal = document.getElementById('flightSearchLoadingModal');
		
		let chatMode = 'recommend'; // [ì‹ ê·œ] 'recommend' or 'follow-up'

		// --- DOMContentLoaded ë¦¬ìŠ¤ë„ˆ (ìˆ˜ì •) ---
		document.addEventListener('DOMContentLoaded', (event) => {
			loadChatHistory();
		});

		// --- [ìˆ˜ì •] ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: 'submit' ëŒ€ì‹  'click'ê³¼ 'keypress' ì‚¬ìš© ---
		// messageForm.addEventListener('submit', sendMessage, true); // (ì œê±°)
		sendButton.addEventListener('click', sendMessage, true);
		messageInput.addEventListener('keypress', function(e) {
			if (e.key === 'Enter') {
				e.preventDefault();
				sendMessage(e);
			}
		});
		
		// [ì‹ ê·œ] 'ìƒˆë¡œìš´ ì—¬í–‰ ì¶”ì²œë°›ê¸°' ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
		newSearchButton.addEventListener('click', function() {
			setChatMode('recommend');
		});


		// --- [ìˆ˜ì •] loadChatHistory í•¨ìˆ˜ ---
		async function loadChatHistory() {
			try {
				const response = await fetch('/chat/history');
				if (!response.ok) {
					throw new Error('History fetch failed');
				}
				const history = await response.json();
				localConversationHistory = history;
				history.forEach(message => {
					// [ìˆ˜ì •] user ë©”ì‹œì§€ë„ í‘œì‹œ (ë‹¨, JSON í˜•ì‹ì˜ AI ë©”ì‹œì§€ê°€ ì•„ë‹ ê²½ìš°)
					if (message.sender.toLowerCase() === 'ai') {
						try {
							const aiData = JSON.parse(message.content);
							displayMessage(message.sender, aiData);
						} catch (e) {
							// íˆìŠ¤í† ë¦¬ì— ì¼ë°˜ í…ìŠ¤íŠ¸ê°€ ìˆì„ ê²½ìš°(ë ˆê±°ì‹œ)
							displayMessage(message.sender, { chat_response: message.content });
						}
					}
					// (ì‚¬ìš©ì ë©”ì‹œì§€ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ - historyê°€ user/ai ìŒì´ ì•„ë‹ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
				});
				
				// [ì‹ ê·œ] ë¡œë“œ í›„ ë§ˆì§€ë§‰ ë©”ì‹œì§€ ë¶„ì„í•˜ì—¬ ëª¨ë“œ ì„¤ì •
				const lastAiMsg = [...history].reverse().find(m => m.sender.toLowerCase() === 'ai');
				if(lastAiMsg) {
					try {
						const lastAiData = JSON.parse(lastAiMsg.content);
						if (lastAiData.iataCode && lastAiData.iataCode !== "N/A") {
							setChatMode('follow-up'); // ì´ì „ì— ì¶”ì²œì„ ë°›ì•˜ìœ¼ë¯€ë¡œ í›„ì† ëª¨ë“œ
						} else {
							setChatMode('recommend'); // ì¶”ì²œì´ ì•„ë‹ˆì—ˆìœ¼ë¯€ë¡œ ì¶”ì²œ ëª¨ë“œ
						}
					} catch(e) {
						setChatMode('recommend');
					}
				} else {
					// íˆìŠ¤í† ë¦¬ê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ ì¶”ì²œ ëª¨ë“œ
					setChatMode('recommend');
				}
				
			} catch (error) {
				console.error('Error loading chat history:', error);
				const defaultMsg = { sender: "AI", content: "ì•ˆë…•í•˜ì„¸ìš”! ì–´ë–¤ ì—¬í–‰ ìŠ¤íƒ€ì¼ì„ ì›í•˜ì‹œë‚˜ìš”?" };
				const defaultMsgJson = {
					chat_response: defaultMsg.content,
					activities: []
				};
				localConversationHistory.push({
					sender: defaultMsg.sender,
					content: JSON.stringify(defaultMsgJson)
				});
				displayMessage(defaultMsg.sender, defaultMsgJson);
				setChatMode('recommend'); // ë¡œë”© ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì¶”ì²œ ëª¨ë“œ
			} finally {
				connect();
			}
		}

		// --- connect í•¨ìˆ˜ (ìˆ˜ì • ì—†ìŒ) ---
		function connect() {
			const socket = new SockJS('/ws-chatin');
			stompClient = Stomp.over(socket);

			stompClient.connect({}, function(frame) {
				console.log('Connected: ' + frame);
				stompClient.subscribe('/user/queue/reply', function(message) {
					removeLoadingIndicator();
					const chatMessagePayload = JSON.parse(message.body);
					const aiRawJson = chatMessagePayload.content;
					try {
						const aiData = JSON.parse(aiRawJson);
						displayMessage(chatMessagePayload.sender, aiData);
						localConversationHistory.push({
							sender: chatMessagePayload.sender,
							content: aiRawJson
						});
					} catch (e) {
						console.error("AI ì‘ë‹µ (JSON) íŒŒì‹± ì˜¤ë¥˜:", e, aiRawJson);
						const errorData = { chat_response: "ì£„ì†¡í•©ë‹ˆë‹¤, ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." };
						displayMessage("AI", errorData);
						localConversationHistory.push({
							sender: "AI",
							content: JSON.stringify(errorData)
						});
					}
				});
			});
		}


		/**
		 * [ìˆ˜ì •ë¨] sendMessage
		 * - chatModeì— ë”°ë¼ ë‹¤ë¥¸ ë¡œì§ ìˆ˜í–‰
		 * - payloadì— 'type' ì¶”ê°€
		 */
		function sendMessage(event) {
			event.preventDefault();

			const userText = messageInput.value.trim();
			let llmPrompt; // AIì—ê²Œ ë³´ë‚¼ ë‚´ìš©
			let userDisplayMessage; // í™”ë©´ì— í‘œì‹œí•  ì‚¬ìš©ì ë©”ì‹œì§€
			let messageType = chatMode; // 'recommend' or 'follow-up'

			if (chatMode === 'recommend') {
				// [ëª¨ë“œ 1: ì¶”ì²œ]
				const departureSelect = document.getElementById('selectDeparture');
				const departureDateInput = document.getElementById('selectDate');
				const regionSelect = document.getElementById('selectRegion');
				const themeSelect = document.getElementById('selectTheme');
				const durationSelect = document.getElementById('selectDuration');
				const budgetSelect = document.getElementById('selectBudget');

				const departure = departureSelect.options[departureSelect.selectedIndex].text;
				const departureDate = departureDateInput.value;
				const region = regionSelect.options[regionSelect.selectedIndex].text;
				const theme = themeSelect.options[themeSelect.selectedIndex].text;
				const duration = durationSelect.options[durationSelect.selectedIndex].text;
				const budget = budgetSelect.options[budgetSelect.selectedIndex].text;

				if (!departureDate) {
					alert('ì¶œë°œ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
					departureDateInput.focus();
					return;
				}
				if (!userText) {
					alert('ì¶”ê°€ ìš”ì²­ ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: ì¡°ìš©í•œ ê³³ì´ì—ˆìœ¼ë©´ ì¢‹ê² ì–´ìš”)');
					messageInput.focus();
					return;
				}

				llmPrompt = `
[ì„ íƒ ì¡°ê±´]
- ì¶œë°œì§€: ${departure}
- ì¶œë°œ ë‚ ì§œ: ${departureDate}
- ì§€ì—­: ${region}
- í…Œë§ˆ: ${theme}
- ê¸°ê°„: ${duration}
- ê²½ë¹„: ${budget}
[ì‚¬ìš©ì ì¶”ê°€ ìš”ì²­]
- ${userText}
				`;
				
				// í™”ë©´ì—ëŠ” ì‚¬ìš©ì ì¶”ê°€ ìš”ì²­ë§Œ í‘œì‹œ
				userDisplayMessage = userText; 
			
			} else {
				// [ëª¨ë“œ 2: í›„ì† ì§ˆë¬¸]
				if (!userText) {
					alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
					messageInput.focus();
					return;
				}
				llmPrompt = userText;
				userDisplayMessage = userText;
			}


			if (llmPrompt && stompClient) {
				displayMessage("user", userDisplayMessage);
				displayLoadingIndicator(); 

				// ë¡œì»¬ íˆìŠ¤í† ë¦¬ì—ëŠ” AIê°€ ì²˜ë¦¬í•  ì›ë³¸(llmPrompt)ì„ ì €ì¥
				localConversationHistory.push({
					sender: "user",
					content: llmPrompt
				});

				const payload = {
					type: messageType, // [ì‹ ê·œ] ë©”ì‹œì§€ íƒ€ì… ì „ì†¡
					content: llmPrompt,
					history: localConversationHistory
				};

				stompClient.send("/app/sendMessage", {}, JSON.stringify(payload));
				messageInput.value = '';
			}
		}

		/**
		 * [ìˆ˜ì •ë¨] displayMessage
		 * - AI ì‘ë‹µì— iataCodeê°€ ìˆìœ¼ë©´ chatModeë¥¼ 'follow-up'ìœ¼ë¡œ ë³€ê²½
		 */
		function displayMessage(sender, content) {
			const messageElement = document.createElement('div');
			let messageHTML = '';

			if (sender.toLowerCase() === 'ai') {
				messageElement.classList.add('receiveMsg');

				// 'content'ê°€ ê°ì²´(JSON)ê°€ ì•„ë‹Œ ë¬¸ìì—´ë¡œ ì˜¤ëŠ” ê²½ìš° ì²˜ë¦¬ (ì˜ˆ: ë ˆê±°ì‹œ)
				if (typeof content === 'string') {
					content = { chat_response: content };
				}

				if (content && content.chat_response) {
					let html = `${content.chat_response.replace(/\n/g, '<br>')}`;

					// ì¶”ì²œ í™œë™ì´ ìˆëŠ” ê²½ìš°
					if (content.activities && content.activities.length > 0) {
						html += '<br><hr style="margin-top: 10px; margin-bottom: 10px; border: 0; border-top: 1px solid #eee;">';
						html += '<strong style="color: #5ac4c9;">ì¶”ì²œ ì¥ì†Œ:</strong>';
						html += '<ul style="margin-top: 8px; margin-bottom: 0; padding-left: 20px;">';
						content.activities.forEach(activity => {
							html += `<li>${activity.replace(/\n/g, '<br>')}</li>`;
						});
						html += '</ul>';
					}

					// í•­ê³µê¶Œ ê²€ìƒ‰ ë²„íŠ¼ì´ ìˆëŠ” ê²½ìš° (ì¶”ì²œ ì‘ë‹µ)
					if (content.iataCode && content.iataCode !== "N/A" && content.city) {
						html += `
							<button class="btn-flight-search"
									onclick="searchFlights('${content.iataCode}', '${content.city}')">
								âœˆï¸ ${content.city} í•­ê³µê¶Œ ê²€ìƒ‰í•˜ê¸°
							</button>
						`;
					}

					messageHTML = `
						<div>
							<div class="msgContent">${html}</div>
						</div>
					`;
					
					// [ì‹ ê·œ] ì¶”ì²œ ì‘ë‹µ(iataCode)ì„ ë°›ìœ¼ë©´ ëª¨ë“œ ë³€ê²½
					if (content.iataCode && content.iataCode !== "N/A") {
						setChatMode('follow-up');
					}

				} else {
					console.warn("AI ì‘ë‹µ ê°ì²´ì— chat_responseê°€ ì—†ìŠµë‹ˆë‹¤:", content);
					messageHTML = `<div><div class="msgContent">ì‘ë‹µì„ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div></div>`;
				}

			} else { // 'user'
				messageElement.classList.add('sendMsg');
				const userContent = content || "(ë‚´ìš© ì—†ìŒ)";
				messageHTML = `
					<div>
						<div class="msgContent">${userContent.replace(/\n/g, '<br>')}</div>
					</div>
				`;
			}

			messageElement.innerHTML = messageHTML;
			chatBox.appendChild(messageElement);
			chatBox.scrollTop = chatBox.scrollHeight;
		}

		
		/**
		 * [ì‹ ê·œ] setChatMode
		 * - UI ìƒíƒœ(í¼, ë²„íŠ¼, í”Œë ˆì´ìŠ¤í™€ë”)ì™€ 'chatMode' ë³€ìˆ˜ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
		 */
		function setChatMode(mode) {
			const recommendContainer = document.getElementById('recommendationFormContainer');
			const newSearchContainer = document.getElementById('newSearchContainer');
				
			if (mode === 'follow-up') {
				chatMode = 'follow-up';
				if (recommendContainer) recommendContainer.style.display = 'none';
				if (newSearchContainer) newSearchContainer.style.display = 'block';
				messageInput.placeholder = 'ì¶”ì²œëœ ì—¬í–‰ì§€ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”...';
			} else { // 'recommend'
				chatMode = 'recommend';
				if (recommendContainer) recommendContainer.style.display = 'block';
				if (newSearchContainer) newSearchContainer.style.display = 'none';
				messageInput.placeholder = 'ì¶”ê°€ ìš”ì²­ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”';
					
				// [ì„ íƒ ì‚¬í•­] ìƒˆ ì¶”ì²œ ì‹œì‘ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€ ì¶”ê°€
				// (í˜ì´ì§€ ë¡œë“œ ì‹œê°€ ì•„ë‹ ë•Œë§Œ ë©”ì‹œì§€ í‘œì‹œ)
				if (localConversationHistory.length > 0 && newSearchButton.style.display === 'block') {
					const newSearchMsg = { 
						chat_response: "ìƒˆë¡œìš´ ì—¬í–‰ì§€ ì¶”ì²œì„ ì‹œì‘í•©ë‹ˆë‹¤. ì›í•˜ì‹œëŠ” ì¡°ê±´ì„ ì„ íƒí•˜ê³  ìš”ì²­ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." 
					};
					displayMessage("AI", newSearchMsg);
					localConversationHistory.push({
						sender: "AI",
						content: JSON.stringify(newSearchMsg)
					});
				}
			}
		}

		
		// --- ë¡œë”© ì¸ë””ì¼€ì´í„° í•¨ìˆ˜ (ìˆ˜ì • ì—†ìŒ) ---
		function displayLoadingIndicator() {
			removeLoadingIndicator();
			const messageElement = document.createElement('div');
			messageElement.classList.add('receiveMsg');
			messageElement.id = 'loadingIndicator';
			const content = `
				<div class="msgContent" style="background-color: #f8f9fa; color: #495057;">
					<div class="spinner"></div>
					ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...
				</div>
			`;
			messageElement.innerHTML = `<div>${content}</div>`;
			chatBox.appendChild(messageElement);
			chatBox.scrollTop = chatBox.scrollHeight;
		}
		function removeLoadingIndicator() {
			const loader = document.getElementById('loadingIndicator');
			if (loader) {
				loader.remove();
			}
		}

		// --- searchFlights í•¨ìˆ˜ (ìˆ˜ì • ì—†ìŒ) ---
		function searchFlights(arrivalCode, arrivalCityName) {
			console.log("í•­ê³µê¶Œ ê²€ìƒ‰:", arrivalCode, arrivalCityName);
			if (flightSearchLoadingModal) {
				flightSearchLoadingModal.style.display = 'flex';
			}
			
			const departureSelect = document.getElementById('selectDeparture');
			const departureDate = document.getElementById('selectDate').value;
			const durationSelect = document.getElementById('selectDuration');

			const departureCode = departureSelect.value;
			const departureKoLocation = departureSelect.options[departureSelect.selectedIndex].text;
			const durationText = durationSelect.options[durationSelect.selectedIndex].text;

			let returnDate = "";
			let tripType = "one-way";

			if (durationText !== "ìƒê´€ì—†ì–´ìš”" && durationText !== "any") {
				returnDate = calculateReturnDate(departureDate, durationText);
				tripType = "round-trip";
			}

			const adults = "1";
			const children = "0";
			const infants = "0";
			const travelClass = "ECONOMY";
			const directFlight = false;

			const form = document.createElement('form');
			form.method = 'POST';
			form.action = '/air/searchAirport';

			createHiddenInput(form, 'departureCode', departureCode);
			createHiddenInput(form, 'arrivalCode', arrivalCode);
			createHiddenInput(form, 'departureDate', departureDate);
			createHiddenInput(form, 'returnDate', returnDate);
			createHiddenInput(form, 'tripType', tripType);
			createHiddenInput(form, 'adults', adults);
			createHiddenInput(form, 'children', children);
			createHiddenInput(form, 'infants', infants);
			createHiddenInput(form, 'travelClass', travelClass);
			createHiddenInput(form, 'directFlight', directFlight.toString());
			createHiddenInput(form, 'departureKoLocation', departureKoLocation);
			createHiddenInput(form, 'arrivalKoLocation', arrivalCityName);

			document.body.appendChild(form);
			setTimeout(() => {
				form.submit();
			}, 100);
		}

		// --- createHiddenInput í•¨ìˆ˜ (ìˆ˜ì • ì—†ìŒ) ---
		function createHiddenInput(form, name, value) {
			const input = document.createElement('input');
			input.type = 'hidden';
			input.name = name;
			input.value = value;
			form.appendChild(input);
		}

		// --- calculateReturnDate í•¨ìˆ˜ (ìˆ˜ì • ì—†ìŒ) ---
		function calculateReturnDate(startDate, durationText) {
			try {
				const nights = parseInt(durationText.match(/\d+/)?.[0]);
				if (isNaN(nights)) { return ""; }
				const date = new Date(startDate);
				date.setDate(date.getDate() + nights);
				const year = date.getFullYear();
				const month = (date.getMonth() + 1).toString().padStart(2, '0');
				const day = date.getDate().toString().padStart(2, '0');
				return `${year}-${month}-${day}`;
			} catch (e) {
				console.error("ë‚ ì§œ ê³„ì‚° ì˜¤ë¥˜:", e);
				return "";
			}
		}

		// --- window.onbeforeunload í•¨ìˆ˜ (ìˆ˜ì • ì—†ìŒ) ---
		window.onbeforeunload = function() {
			if (stompClient !== null) {
				stompClient.disconnect();
			}
		};
	</script>

</body>
</html>